<!DOCTYPE html>
<html lang="sq">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AIC • Detyra (mailto i gatshëm)</title>
<style>
  :root{ --bg:#f7f8fb; --surface:#ffffff; --text:#0f172a; --muted:#cbd5e1; --line:#e5e7eb;
         --primary:#2563eb; --ok:#22c55e; --danger:#ef4444; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:var(--bg)}
  .app{display:grid; grid-template-columns: 270px 1fr; height:100vh}
  .sidebar{background:#0b1220; color:#e2e8f0; padding:12px 10px; overflow:auto}
  .content{display:flex; flex-direction:column; min-width:0}
  .topbar{height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 16px; background:var(--surface); border-bottom:1px solid var(--line)}
  .page{padding:16px; overflow:auto}
  .sb-h{font-size:12px; color:#94a3b8; letter-spacing:.08em; text-transform:uppercase; padding:10px 10px 6px}
  .fav{padding:6px 10px; display:flex; align-items:center; gap:8px; color:#e2e8f0}
  .fav:hover{background:#111827; border-radius:8px}
  .space-row{margin-bottom:2px}
  .space-item{padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px}
  .space-item:hover{background:#111827}
  .avatar{width:22px;height:22px;border-radius:6px;display:inline-grid;place-items:center;font-size:12px;font-weight:700;color:#0b1220}
  .name{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .icon-btn{width:22px;height:22px;border:1px dashed #334155; border-radius:6px; display:inline-grid; place-items:center; color:#94a3b8; cursor:pointer}
  .icon-btn:hover{background:#111827}
  .trash{border-color:#7f1d1d; color:#fca5a5}
  .children{margin:4px 0 8px 42px; display:none}
  .children.open{display:block}
  .child{padding:6px 8px; font-size:14px; color:#cbd5e1; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .child:hover{background:#0f172a}
  .child .x{margin-left:auto; opacity:.7; font-weight:700; padding:0 6px; border-radius:6px; cursor:pointer}
  .child .x:hover{background:#111827; color:#fecaca}
  .child.active{background:#1f2937; color:#fff}
  .new-space{padding:6px 10px; margin:6px 10px; color:#94a3b8; display:flex; align-items:center; gap:8px}
  .panel{background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:14px}
  .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:12px}
  .input{height:36px; border:1px solid var(--line); border-radius:10px; padding:0 10px; background:#fff}
  .tag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); background:#fff; border-radius:10px; font-size:13px}
  .status-dot{width:10px;height:10px;border-radius:999px;background:var(--ok);display:inline-block}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
  .btn.small{padding:6px 10px; font-size:13px}
  table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden}
  thead th{ text-align:left; font-size:13px; color:#475569; font-weight:600; padding:12px; background:#f8fafc; border-bottom:1px solid var(--line)}
  tbody td{ padding:12px; border-bottom:1px solid var(--line); background:#fff}
  tbody tr:last-child td{border-bottom:none}
  .pill{padding:6px 10px; border:1px solid var(--line); border-radius:10px; background:#f8fafc}
  .overlay{position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{width:740px; max-width:92vw; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden}
  .modal header{padding:16px 18px; font-weight:700; font-size:20px; border-bottom:1px solid var(--line)}
  .modal .body{padding:16px 18px}
  .modal .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .field{display:flex; flex-direction:column; gap:6px}
  .field label{font-size:14px; color:#334155}
  .field input[type="text"], .field input[type="email"], .field input[type="date"], .field select, .field textarea{
    height:40px; border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px; background:#fff;
  }
  .field textarea{height:120px; resize:vertical}
  .status-row{display:flex; gap:8px; align-items:center}
  .status-chip{border:1px solid var(--line); border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none}
  .status-chip.active{border-color:#93c5fd; background:#eff6ff; color:#1d4ed8}
  .modal footer{display:flex; justify-content:flex-end; gap:10px; padding:16px 18px; border-top:1px solid var(--line); background:#f8fafc}
  .upload{border:1px dashed #cbd5e1; border-radius:12px; padding:14px; background:#f9fafb}
  .drop{border:1px dashed #cbd5e1; border-radius:10px; padding:18px; text-align:center; font-size:14px; color:#475569; background:#fff}
  .filelist{margin-top:10px; display:flex; flex-direction:column; gap:6px; max-height:160px; overflow:auto}
  .fileitem{display:flex; justify-content:space-between; gap:10px; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff}
  .fileitem a{color:#2563eb; text-decoration:underline}
  .hint{font-size:12px; color:#64748b; margin-top:8px}

  /* === Status Colors === */
  .status-select{ border-radius: 999px; padding: 4px 10px; color:#fff; border:none; font-weight:600; }
  .status-open{ background:#22c55e; }      /* green */
  .status-close{ background:#ef4444; }     /* red */
  .status-done{ background:#10b981; }      /* emerald */
  .status-progress{ background:#3b82f6; }  /* blue */
  .status-onhold{ background:#f59e0b; }    /* amber */
  .status-blocked{ background:#6b7280; }   /* gray */
</style>
</head>
<body>
<div class="app" id="appRoot">
  <aside class="sidebar">
    <div class="sb-h">Favorites</div>
    <div class="fav">⭐ All Tasks - Aicorporation</div>
    <div class="sb-h" style="display:flex; align-items:center; justify-content:space-between">
      <span>Spaces</span>
      <div id="btnAddSpace" class="icon-btn" title="Shto Hapësirë">+</div>
    </div>
    <div id="spacesWrap"></div>
    <div id="btnNewSpace" class="new-space">＋ New Space</div>
  </aside>

  <main class="content">
    <div class="topbar">
      <div style="font-weight:600">AIC Tasks</div>
      <div></div>
    </div>

    <div class="page">
      <div id="taskPanel" class="panel" style="display:none">
        <div class="toolbar">
          <div style="flex:1"></div>
          <!-- KJO KUTI RUAJTET dhe PËRDORET për dërgim -->
          <input id="myEmail" class="input" style="width:260px" placeholder="Email-i im:" value="@aicorporation.al">
          <!-- Owner filter -->
          <select id="filterOwner" class="input">
            <option value="">Të gjitha</option>
            <option value="mine">Vetëm të mia</option>
          </select>
          <!-- Priority filter -->
          <select id="filterPriority" class="input">
            <option value="">Prioriteti</option>
            <option value="I Lartë">I Lartë</option>
            <option value="Mesëm">Mesëm</option>
            <option value="I Ulët">I Ulët</option>
          </select>
          <!-- Status filter -->
          <select id="filterStatus" class="input">
            <option value="">Statusi</option>
            <option value="OPEN">OPEN</option>
            <option value="IN PROGRESS">IN PROGRESS</option>
            <option value="DONE">DONE</option>
            <option value="CLOSED">CLOSED</option>
          </select>

          <button id="btnAddTask" class="btn primary">Add Task</button>
          <button id="btnAddColumn" class="btn">+ Kolonë</button>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr id="taskHeadRow">
                <th style="width:28%">Emri</th>
                <th style="width:12%">Assignee</th>
                <th style="width:10%">Afati</th>
                <th style="width:12%">Prioriteti</th>
                <th style="width:12%">Email assignee</th>
                <th style="width:10%">Status</th>
                <th style="width:16%">Veprime</th>
              </tr>
            </thead>
            <tbody id="taskBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- MODAL Add/Edit Task -->
<div id="overlay" class="overlay">
  <div class="modal">
    <header>Detyrë</header>
    <div class="body">
      <div class="grid">
        <div class="field"><label>Titulli</label><input id="f_title" type="text" placeholder="p.sh. Përgatit draft-kontratën"></div>
        <div class="field"><label>Assignee</label><input id="f_assignee" type="text" placeholder="Emri / inicialet"></div>
        <div class="field"><label>Email i assignee</label><input id="f_email" type="email" placeholder="emri@aicorporation.al"></div>
        <div class="field"><label>Afati</label><input id="f_due" type="date"></div>
        <div class="field"><label>Prioriteti</label>
          <select id="f_priority"><option>Mesëm</option><option>I Lartë</option><option>I Ulët</option></select>
        </div>
        <div class="field"><label>Statusi</label>
          <div id="f_status" class="status-row">
            <div data-v="OPEN" class="status-chip active">OPEN</div>
            <div data-v="CLOSED" class="status-chip">CLOSED</div>
          </div>
        </div>
        <div class="field" style="grid-column:1 / -1">
          <label>Përshkrimi</label><textarea id="f_desc" placeholder="Detaje të shkurtra..."></textarea>
        </div>
      </div>

      <div class="upload" id="uploadBox">
        <div class="field">
          <label>Dokumente (vetëm listim lokal për demonstrim)</label>
          <div id="drop" class="drop">
            Zvarrit dhe lësho dokumentat këtu, ose <u>zgjidh nga kompjuteri</u>.
            <input id="fileInput" type="file" multiple style="display:none">
          </div>
          <div class="hint" id="folderHint">Dosja: <b id="folderPath">/docs/—</b></div>
          <div id="fileList" class="filelist"></div>
        </div>
      </div>
    </div>
    <footer>
      <button id="btnCancel" class="btn">Anulo</button>
      <button id="btnSave" class="btn primary">Ruaj</button>
    </footer>
  </div>
</div>


<script src="./data/users.js?v=20250930144350"></script>
<script>
/* ------------------ Persistenca & konfigurimi ------------------ */
const KEY = "aicTasksV1";
const MYMAIL_KEY = "aicMyEmail";
let data = [];
let current = { spaceIndex:null, listIndex:null };
let editingTaskIndex = null;

/* 🔎 Filtrat */
let priorityFilter = "";
let ownerFilter = "";   // "" | "mine"
let statusFilter = "";  // "" | "OPEN" | "IN PROGRESS" | "DONE" | "CLOSED"

function saveData(){
  const clean = JSON.parse(JSON.stringify(data));
  clean.forEach(sp=>sp.lists?.forEach(ls=>ls.tasks?.forEach(t=>{
    if(t.files){ t.files = t.files.map(({name,size,type})=>({name,size,type})); }
  })));
  localStorage.setItem(KEY, JSON.stringify(clean));
}
function loadData(){
  try{
    const raw = localStorage.getItem(KEY);
    if(raw){
      data = JSON.parse(raw);
      data.forEach(sp=>sp.lists?.forEach(ls=>{ if(!ls.columns) ls.columns=[]; }));
      return;
    }
  }catch{}
  data = []; saveData();
}

/* ------------------ Sidebar ------------------ */
const spacesWrap = document.getElementById("spacesWrap");
function renderSidebar(){
  spacesWrap.innerHTML = "";
  data.forEach((sp, sidx) => {
    const row = document.createElement("div"); row.className="space-row";
    const item = document.createElement("div"); item.className = "space-item";
    const avatar = document.createElement("div"); avatar.className = "avatar"; avatar.style.background = sp.color || "#f59e0b"; avatar.textContent = (sp.name?.trim()[0] || "S").toUpperCase();
    const name = document.createElement("div"); name.className = "name"; name.textContent = sp.name;
    name.ondblclick = (e)=>{ e.stopPropagation(); inlineRenameSpace(sidx, name); };
    const addListBtn = document.createElement("div"); addListBtn.className = "icon-btn"; addListBtn.title = "Shto Listë"; addListBtn.onclick = (e)=>{ e.stopPropagation(); addList(sidx); };
    const deleteSpaceBtn = document.createElement("div"); deleteSpaceBtn.className = "icon-btn trash"; deleteSpaceBtn.title="Fshi Hapësirën"; deleteSpaceBtn.textContent = "🗑"; deleteSpaceBtn.style.fontSize="12px"; deleteSpaceBtn.onclick = (e)=>{ e.stopPropagation(); deleteSpace(sidx); };
    item.append(avatar, name, addListBtn, deleteSpaceBtn);
    item.onclick = ()=>{ row.querySelector(".children").classList.toggle("open"); };
    const children = document.createElement("div"); children.className="children";
    (sp.lists||[]).forEach((ls, lidx) => {
      const c = document.createElement("div"); c.className="child";
      const txt = document.createElement("div"); txt.textContent = ls.name;
      txt.ondblclick = (e)=>{ e.stopPropagation(); inlineRenameList(sidx, lidx, txt); };
      const x = document.createElement("div"); x.className="x"; x.title="Fshi Listën"; x.textContent="×"; x.onclick = (e)=>{ e.stopPropagation(); deleteList(sidx, lidx); };
      c.onclick = (e)=>{ e.stopPropagation(); openList(sidx, lidx); };
      c.append(txt, x); children.append(c);
    });
    row.append(item, children); spacesWrap.append(row);
  });
}
function addSpace(){
  const name = prompt("Emri i Hapësirës:", "Hapësirë e re"); if(!name) return;
  const color = "#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0");
  data.push({name, color, lists:[]}); saveData(); renderSidebar();
}
function deleteSpace(sidx){
  if(!confirm(`Ta fshij “${data[sidx].name}” dhe të gjitha Listat/Detyrat e saj?`)) return;
  data.splice(sidx,1);
  if(current.spaceIndex===sidx){ document.getElementById("taskPanel").style.display="none"; current={spaceIndex:null,listIndex:null}; }
  saveData(); renderSidebar();
}
function addList(sidx){
  const name = prompt("Emri i Listës:", "Listë e re"); if(!name) return;
  data[sidx].lists = data[sidx].lists || [];
  data[sidx].lists.push({name, tasks:[], columns:[]}); saveData(); renderSidebar();
  const block = spacesWrap.children[sidx]; if(block){ block.querySelector(".children").classList.add("open"); }
}
function deleteList(sidx, lidx){
  if(!confirm(`Ta fshij Listën “${data[sidx].lists[lidx].name}”?`)) return;
  data[sidx].lists.splice(lidx,1);
  if(current.spaceIndex===sidx && current.listIndex===lidx){ document.getElementById("taskPanel").style.display="none"; current={spaceIndex:null,listIndex:null}; }
  saveData(); renderSidebar();
}
document.getElementById("btnAddSpace").onclick = addSpace;
document.getElementById("btnNewSpace").onclick = addSpace;


/* ------------------ Dynamic Columns (per List) ------------------ */
function ensureListSchema(ls){
  if(!ls.columns) ls.columns = [];               // [{id,name,type}]
  if(!ls.tasks)   ls.tasks   = [];
  ls.tasks.forEach(t=>{ if(!t.extras) t.extras = {}; });
}
function genId(){ return "c" + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function addColumnPrompt(){
  const name = prompt("Titulli i kolonës:", "Kolonë e re"); if(!name) return;
  let type = prompt("Tipi i kolonës (text | checkbox | date):", "text");
  type = (type||"text").trim().toLowerCase();
  if(!['text','checkbox','date'].includes(type)) type = 'text';
  const ls = data[current.spaceIndex].lists[current.listIndex];
  ensureListSchema(ls);
  const col = {id: genId(), name, type};
  ls.columns.push(col);
  ls.tasks.forEach(t=>{ if(!t.extras) t.extras={}; t.extras[col.id] = (type==='checkbox'? false : ''); });
  saveData();
  rebuildTaskHeader(); renderTasks();
}
function renameColumn(ls, cidx, thEl){
  if(typeof makeInlineRename === 'function'){
    makeInlineRename(thEl, ls.columns[cidx].name, (v)=>{ ls.columns[cidx].name=v; saveData(); rebuildTaskHeader(); });
  }else{
    const v = prompt('Emri i ri i kolonës:', ls.columns[cidx].name);
    if(v){ ls.columns[cidx].name=v; saveData(); rebuildTaskHeader(); }
  }
}
function rebuildTaskHeader(){
  const headRow = document.getElementById('taskHeadRow');
  if(!headRow) return;
  headRow.innerHTML = '';
  const base = [
    ['Emri','28%'],
    ['Assignee','12%'],
    ['Afati','10%'],
    ['Prioriteti','12%'],
    ['Email assignee','12%']
  ];
  base.forEach(([label,w])=>{
    const th=document.createElement('th'); if(w) th.style.width=w; th.textContent=label; headRow.append(th);
  });
  const ls = data?.[current.spaceIndex]?.lists?.[current.listIndex];
  if(ls){
    ensureListSchema(ls);
    ls.columns.forEach((col, cidx)=>{
      const th=document.createElement('th'); th.textContent=col.name; th.className='col-dynamic';
      th.title='Double-click për të riemërtuar';
      th.ondblclick = ()=>renameColumn(ls, cidx, th);
      headRow.append(th);
    });
  }
  const thStatus=document.createElement('th'); thStatus.style.width='10%'; thStatus.textContent='Status'; headRow.append(thStatus);
  const thAct=document.createElement('th'); thAct.style.width='16%'; thAct.textContent='Veprime'; headRow.append(thAct);
}
setTimeout(()=>{ const btn=document.getElementById('btnAddColumn'); if(btn) btn.onclick=addColumnPrompt; },0);

/* ------------------ Status helpers ------------------ */
function statusClassFor(val){
  if(!val) return 'status-progress';
  const v = (''+val).toLowerCase().replace(/\s+/g,'');
  if(v==='open') return 'status-open';
  if(v==='close' || v==='closed') return 'status-close';
  if(v==='done' || v==='completed') return 'status-done';
  if(v==='inprogress' || v==='progress') return 'status-progress';
  if(v==='onhold' || v==='hold') return 'status-onhold';
  if(v==='blocked') return 'status-blocked';
  return 'status-progress';
}
function applyStatusClass(el, val){ el.className = 'status-select ' + statusClassFor(val); }
function refreshAllStatusColors(){
  document.querySelectorAll('select').forEach(s=>{
    if(s && s.options && s.className && s.className.indexOf('status-select')>-1){
      applyStatusClass(s, s.value);
    }
  });
}

/* ------------------ Task table ------------------ */
const taskPanel = document.getElementById("taskPanel");
const taskBody  = document.getElementById("taskBody");
function openList(sidx, lidx){
  current = {spaceIndex:sidx, listIndex:lidx};
  [...document.querySelectorAll(".child")].forEach(el=>el.classList.remove("active"));
  const block = spacesWrap.children[sidx];
  const child = block.querySelectorAll(".child")[lidx];
  if(child) child.classList.add("active");
  taskPanel.style.display = "block";
  renderTasks();
}
function mkButton(txt, disabled=false, onclick=null){
  const b=document.createElement("button"); b.className="pill"; b.textContent=txt; b.disabled=disabled; if(onclick) b.onclick=onclick; return b;
}

function renderTasks(){
  taskBody.innerHTML = "";
  const list = data[current.spaceIndex].lists[current.listIndex];
  ensureListSchema(list);
  rebuildTaskHeader();

  // 🧩 Mblidh dhe aplikoni filtrat
  const myEmail = (document.getElementById("myEmail")?.value || "").trim().toLowerCase();
  let tasks = [...(list.tasks || [])];

  // Filtri i pronarit
  if (ownerFilter === "mine" && myEmail) {
    tasks = tasks.filter(t => (t.email || "").trim().toLowerCase() === myEmail);
  }

  // Filtri i prioritetit
  if (priorityFilter) {
    const pf = priorityFilter.toLowerCase();
    tasks = tasks.filter(t => (t.priority || "").toLowerCase() === pf);
  }

  // Filtri i statusit
  if (statusFilter) {
    tasks = tasks.filter(t => (t.status || "OPEN") === statusFilter);
  }

  // Shfaqja e rreshtave
  tasks.forEach((t, idx) => {
    const tr = document.createElement("tr");
    const td = (html)=>{ const e=document.createElement("td"); e.innerHTML = html; return e; };
    const attach = t.files?.length ? ` &nbsp;📎 (${t.files.length})` : "";
    tr.append(td((t.name||"") + attach));
    tr.append(td(t.assignee||"—"));
    tr.append(td(t.due? new Date(t.due).toLocaleDateString() : "—"));
    tr.append(td(t.priority||"—"));
    tr.append(td(t.email||"—"));

    // Dynamic columns
    list.columns.forEach(col=>{
      const cell = document.createElement("td");
      if(!t.extras) t.extras = {};
      if(!(col.id in t.extras)) t.extras[col.id] = (col.type==="checkbox"? false : "");
      if(col.type === "text"){
        const inp = document.createElement("input"); inp.type="text"; inp.className="input";
        inp.value = t.extras[col.id] || "";
        inp.onchange = ()=>{ t.extras[col.id] = inp.value; saveData(); };
        cell.appendChild(inp);
      }else if(col.type === "date"){
        const inp = document.createElement("input"); inp.type="date"; inp.className="input";
        if(t.extras[col.id]) inp.value = t.extras[col.id];
        inp.onchange = ()=>{ t.extras[col.id] = inp.value; saveData(); };
        cell.appendChild(inp);
      }else{ // checkbox
        const inp = document.createElement("input"); inp.type="checkbox";
        inp.checked = !!t.extras[col.id];
        inp.onchange = ()=>{ t.extras[col.id] = inp.checked; saveData(); };
        cell.appendChild(inp);
      }
      tr.append(cell);
    });

    const statusTd = document.createElement("td");
    const sel = document.createElement("select"); applyStatusClass(sel, t.status); sel.className="input";
    ["OPEN","IN PROGRESS","DONE","CLOSED"].forEach(st=>{
      const o=document.createElement("option"); o.value=st; o.textContent=st; if((t.status||"OPEN")===st) o.selected=true; sel.append(o);
    });
    sel.onchange = () => { applyStatusClass(sel, sel.value); t.status = sel.value; saveData(); };
    applyStatusClass(sel, sel.value || t.status);
    statusTd.append(sel); tr.append(statusTd);

    const actions = document.createElement("td");
    const wrap = document.createElement("div"); wrap.style.display="flex"; wrap.style.gap="8px";
    const bEmail = mkButton("Dërgo Email", false, ()=>sendEmail(t));
    const bEdit  = mkButton("Ndrysho", false, ()=>openModal(idx));
    const bDel   = mkButton("Fshi", false, ()=>deleteTask(idx));
    const bDocs  = mkButton("Dokumente", false, ()=>showFiles(idx));
    wrap.append(bEmail,bEdit,bDel,bDocs); actions.append(wrap); tr.append(actions);

    taskBody.append(tr);
  });
}
function deleteTask(i){
  if(!confirm("Ta fshij detyrën?")) return;
  const list = data[current.spaceIndex].lists[current.listIndex];
  list.tasks.splice(i,1); saveData(); renderTasks();
}
document.getElementById("btnAddTask").onclick = ()=>openModal(null);

/* ------------------ Dërgo Email (mailto) ------------------ */
function sendEmail(task){
  try{
    const s = JSON.parse(localStorage.getItem("APP_SESSION")||"{}");
    const isEditor = (s.role||"").toLowerCase()==="editor";
    if(!isEditor){ alert("Veprimi lejohet vetëm për rolin 'editor'."); return; }
  }catch(e){}
const myEmailEl = document.getElementById("myEmail");
  const senderRemember = (myEmailEl?.value||"").trim();
  if(senderRemember) localStorage.setItem(MYMAIL_KEY, senderRemember);

  const to = encodeURIComponent((task.email||"").trim());
  const subject = encodeURIComponent("Detyrë: " + (task.name||""));
  const docs = (task.files||[]).map(f => `- ${f.name||""}`).join("\n");
  const body = encodeURIComponent(
`Përshëndetje,

Detyrë: ${task.name||"—"}
Afati: ${task.due||"—"}
Prioriteti: ${task.priority||"—"}
Statusi: ${task.status||"OPEN"}

Përshkrimi:
${task.desc||"—"}

Lidhjet:
${docs||"—"}

Dërguar nga: ${senderRemember||"-"}
`);
  window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
}

/* ------------------ Modal & Upload (lokal) ------------------ */
const overlay = document.getElementById("overlay");
const f_title  = document.getElementById("f_title");
const f_assignee = document.getElementById("f_assignee");
const f_email  = document.getElementById("f_email");
const f_due    = document.getElementById("f_due");
const f_priority = document.getElementById("f_priority");
const f_desc   = document.getElementById("f_desc");
const f_status = document.getElementById("f_status");
const folderPath = document.getElementById("folderPath");
const fileInput  = document.getElementById("fileInput");
const drop       = document.getElementById("drop");
const fileList   = document.getElementById("fileList");
let tempFiles = []; // [{name,size,type}]

function setStatus(v){
  f_status.querySelectorAll(".status-chip").forEach(ch=>ch.classList.remove("active"));
  const el=[...f_status.children].find(x=>x.dataset.v===v); if(el) el.classList.add("active");
}
function getStatus(){
  const el=[...f_status.children].find(x=>x.classList.contains("active"));
  return el?el.dataset.v:"OPEN";
}
f_status.querySelectorAll(".status-chip").forEach(ch=>ch.onclick = ()=> setStatus(ch.dataset.v));

function openModal(taskIndex){
  if(current.spaceIndex===null) return alert("Zgjidh një Listë nga majtas.");
  editingTaskIndex = taskIndex;
  const sp = data[current.spaceIndex]; const ls = sp.lists[current.listIndex];
  folderPath.textContent = `/docs/${slug(sp.name)}/${slug(ls.name)}/`;
  tempFiles = [];

  if(taskIndex===null){
    f_title.value=""; f_assignee.value=""; f_email.value=""; f_due.value=""; f_priority.value="Mesëm"; f_desc.value="";
    setStatus("OPEN"); renderTempFiles();
  } else {
    const t = ls.tasks[taskIndex];
    f_title.value=t.name||""; f_assignee.value=t.assignee||""; f_email.value=t.email||"";
    f_due.value=t.due? t.due.substring(0,10):""; f_priority.value=t.priority||"Mesëm"; f_desc.value=t.desc||"";
    setStatus(t.status||"OPEN");
    tempFiles = (t.files||[]).slice(); renderTempFiles();
  }
  overlay.style.display="flex";
}
function closeModal(){ overlay.style.display="none"; }
document.getElementById("btnCancel").onclick = closeModal;

document.getElementById("btnSave").onclick = ()=>{
  const list = data[current.spaceIndex].lists[current.listIndex];
  const obj = {
    name: f_title.value || "Untitled",
    assignee: f_assignee.value || "—",
    email: f_email.value || "—",
    due: f_due.value || "",
    priority: f_priority.value,
    desc: f_desc.value || "",
    status: getStatus(),
    files: tempFiles
  };
  if(!list.tasks) list.tasks = [];
  if(editingTaskIndex===null) list.tasks.push(obj); else list.tasks[editingTaskIndex]=obj;
  saveData(); renderTasks(); closeModal();
};

// Upload lokal (vetëm listim; pa server)
drop.onclick = ()=>fileInput.click();
drop.ondragover = (e)=>{ e.preventDefault(); drop.style.background="#f1f5f9"; };
drop.ondragleave = ()=>{ drop.style.background="#fff"; };
drop.ondrop = (e)=>{ e.preventDefault(); drop.style.background="#fff"; handleUpload(e.dataTransfer.files); };
fileInput.onchange = ()=>handleUpload(fileInput.files);
function handleUpload(files){
  [...files].forEach(f=> tempFiles.push({name:f.name, size:f.size, type:f.type}));
  renderTempFiles();
}
function renderTempFiles(){
  fileList.innerHTML="";
  tempFiles.forEach((f,i)=>{
    const row = document.createElement("div"); row.className="fileitem";
    const left = document.createElement("div"); left.textContent = `${f.name} (${Math.round((f.size||0)/1024)} KB)`;
    const right = document.createElement("div");
    const rm = document.createElement("button"); rm.className="btn small"; rm.textContent="Hiq";
    rm.onclick=()=>{ tempFiles.splice(i,1); renderTempFiles(); };
    right.append(rm);
    row.append(left,right); fileList.append(row);
  });
}
function showFiles(i){ openModal(i); }

/* ===== Inline Rename Helpers ===== */
function makeInlineRename(el, initialValue, onSave){
  if(el.dataset.editing === "1") return;
  el.dataset.editing = "1";
  const oldText = initialValue ?? el.textContent.trim();
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldText;
  input.className = "input";
  input.style.height = "28px";
  input.style.padding = "0 8px";
  input.style.borderRadius = "8px";
  input.style.width = Math.max(120, el.clientWidth + 20) + "px";
  el.replaceWith(input);
  input.focus(); input.select();

  let cancelled = false;
  function commit(){
    if(cancelled){ input.replaceWith(el); el.dataset.editing=""; return; }
    const v = input.value.trim() || oldText;
    onSave(v);
    el.textContent = v;
    input.replaceWith(el);
    el.dataset.editing = "";
  }
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); commit(); }
    if(e.key === "Escape"){ cancelled = true; commit(); }
  });
  input.addEventListener("blur", commit);
}
function inlineRenameSpace(sidx, el){
  makeInlineRename(el, null, (v)=>{
    data[sidx].name = v;
    saveData();
    renderSidebar();
  });
}
function inlineRenameList(sidx, lidx, el){
  makeInlineRename(el, null, (v)=>{
    data[sidx].lists[lidx].name = v;
    saveData();
    renderSidebar();
    if(current.spaceIndex===sidx && current.listIndex===lidx){
      renderTasks && renderTasks();
    }
  });
}
/* ------------------ Helpers & Init ------------------ */
function slug(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); }
loadData(); renderSidebar();
const myEmailEl = document.getElementById("myEmail");
myEmailEl.value = localStorage.getItem(MYMAIL_KEY) || myEmailEl.value || "";
myEmailEl.addEventListener("input", ()=>localStorage.setItem(MYMAIL_KEY, myEmailEl.value.trim()));

/* 🔗 Lidh eventet e filtrave */
const filterPriorityEl = document.getElementById("filterPriority");
const filterOwnerEl = document.getElementById("filterOwner");
const filterStatusEl = document.getElementById("filterStatus");

function triggerRefresh(){ renderTasks(); }

filterPriorityEl?.addEventListener("change", () => { priorityFilter = filterPriorityEl.value || ""; triggerRefresh(); });
filterOwnerEl?.addEventListener("change",   () => { ownerFilter = filterOwnerEl.value || "";   triggerRefresh(); });
filterStatusEl?.addEventListener("change",  () => { statusFilter = filterStatusEl.value || ""; triggerRefresh(); });

document.addEventListener('DOMContentLoaded', ()=>{ try{ refreshAllStatusColors(); }catch(e){} });
</script>
<!-- AUTH_ROLE_SCRIPT_START -->
<script>
// ===== Auth & Role (front-end only) =====
(function(){
  const SESSION_KEY = "APP_SESSION";
  let session = { email:null, name:null, role:"viewer" };

  function loadSession(){
    try{
      const s = JSON.parse(localStorage.getItem(SESSION_KEY));
      if(s && s.email){ session = s; }
    }catch(e){}
  }
  function saveSession(){ localStorage.setItem(SESSION_KEY, JSON.stringify(session)); }
  function currentRole(){ return session.role || "viewer"; }
  function canEdit(){ return currentRole() === "editor"; }

  function loginFlow(){
    const last = localStorage.getItem("lastLoginEmail") || "";
    const email = window.prompt("Email-i i hyrjes:", last);
    if(!email) return;
    localStorage.setItem("lastLoginEmail", email);
    const list = (window.UsersStore && window.UsersStore.all) ? window.UsersStore.all() : (window.APP_USERS || []);
    const user = (list || []).find(u => (u.email||"").toLowerCase() === email.toLowerCase());
    if(!user){ alert("Ky email nuk ekziston te data/users.js"); return; }
    session = { email: user.email, name: user.name, role: user.role };
    saveSession(); applyAuthToUI();
  }
  function logout(){
    session = { email:null, name:null, role:"viewer" };
    saveSession(); applyAuthToUI();
  }

  function applyAuthToUI(){
    const who = document.getElementById("whoami");
    const bIn = document.getElementById("btnLogin");
    const bOut = document.getElementById("btnLogout");
    if(who) who.textContent = session.email ? `${session.name} (${session.role})` : "Pa hyrje (viewer)";
    if(bIn) bIn.style.display  = session.email ? "none" : "inline-flex";
    if(bOut) bOut.style.display = session.email ? "inline-flex" : "none";

    const ids = ["btnAddTask","btnAddColumn","btnAddSpace","btnNewSpace"];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if(el) el.disabled = !canEdit();
    });
    // Mbaj një flag global për riemërtim
    window.ALLOW_RENAME = canEdit();

    // Thirr renderTasks nëse ekziston për të rifreskuar disabled state
    if(typeof window.renderTasks === "function"){
      try{ window.renderTasks(); }catch(e){}
    }
  }

  // Krijo UI e vogël Auth në .topbar (nëse ekziston)
  function ensureAuthBox(){
    const topbar = document.querySelector(".topbar");
    if(!topbar) return;
    if(document.getElementById("authBox")) return; // ekziston
    const wrap = document.createElement("div");
    wrap.id = "authBox";
    wrap.style.display = "flex";
    wrap.style.gap = "8px";
    wrap.style.alignItems = "center";
    wrap.style.marginLeft = "auto";
    wrap.innerHTML = `
      <span id="whoami" style="font-size:14px; color:#475569">Pa hyrje (viewer)</span>
      <button id="btnLogin" class="btn small">Login</button>
      <button id="btnLogout" class="btn small" style="display:none">Logout</button>
    `;
    topbar.appendChild(wrap);
    document.getElementById("btnLogin")?.addEventListener("click", loginFlow);
    document.getElementById("btnLogout")?.addEventListener("click", logout);
  }

  // Monkey-patch për të bllokuar veprimet e redaktimit te viewers
  function guard(name){
    const original = window[name];
    if(typeof original !== "function") return;
    if(original.__guarded) return;
    function wrapped(){
      if(!canEdit()){
        alert("Veprimi lejohet vetëm për rolin 'editor'.");
        return;
      }
      return original.apply(this, arguments);
    }
    wrapped.__guarded = true;
    window[name] = wrapped;
  }

  function afterScriptsReady(){
    // Krijo authBox
    ensureAuthBox();
    // Ngarko sesionin
    loadSession();
    // Vendos guards (nëse ekzistojnë këto funksione në app-in tënd)
    ["openModal","addSpace","deleteSpace","addList","deleteList","addTask","deleteTask","renameItem"].forEach(guard);
    // Riemërtimi inline: nëse ekziston makeInlineRename, e zëvendësojmë me variant të lejuar
    if(typeof window.makeInlineRename === "function" && !window.makeInlineRename.__guarded){
      const orig = window.makeInlineRename;
      function renGuarded(){
        if(!canEdit()) return; 
        return orig.apply(this, arguments);
      }
      renGuarded.__guarded = true;
      window.makeInlineRename = renGuarded;
    }
    // Pas çdo renderi, rishiko butonat
    if(typeof window.renderTasks === "function" && !window.renderTasks.__patched){
      const r = window.renderTasks;
      function r2(){
        const out = r.apply(this, arguments);
        // disable controls brenda tabelës (inputs/selects) nëse s'je editor
        try{
          const editableSelectors = ["input[type=text]","input[type=date]","input[type=checkbox]","select"];
          editableSelectors.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => {
              if(el.closest(".tasks-table") || el.closest("table")){
                el.disabled = !canEdit();
              }
            });
          });
          // disable butonat Ndrysho/Fshi që duken si tebd btn
          Array.from(document.querySelectorAll("button")).forEach(b=>{
            const txt = (b.textContent||"").toLowerCase();
            if(["ndrysho","fshi","shto","ruaj","save","edit","delete","add"].some(k=>txt.includes(k))){
              if(b.id !== "btnLogin" && b.id !== "btnLogout"){
                b.disabled = !canEdit();
              }
            }
          });
        }catch(e){}
        return out;
      }
      r2.__patched = true;
      window.renderTasks = r2;
    }
    // Zbato gjendjen fillestare
    applyAuthToUI();
  }

  // Sigurohu që users.js të jetë ngarkuar dhe DOM gati
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", afterScriptsReady);
  }else{
    afterScriptsReady();
  }
})();
</script>

<!-- AUTH_ROLE_SCRIPT_END -->

<!-- HARD LOGIN OVERLAY (always blocks until logged in) -->
<style>
  #hardLoginOverlay{position:fixed;inset:0;background:rgba(15,23,42,.92);display:none;align-items:center;justify-content:center;z-index:99999}
  #hardLoginCard{width:520px;max-width:92vw;background:#0b1220;color:#e2e8f0;border:1px solid #243045;border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.4);}
  #hardLoginCard h2{margin:0 0 8px 0;font-size:22px}
  #hardLoginRow{display:flex;gap:8px;margin-top:14px}
  #hardLoginEmail{flex:1;height:40px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;padding:0 12px}
  #hardLoginBtn{height:40px;border-radius:10px;border:1px solid #2563eb;background:#2563eb;color:#fff;padding:0 14px;cursor:pointer}
  #hardLoginErr{display:none;color:#fca5a5;margin-top:10px;font-size:13px}
</style>
<div id="hardLoginOverlay">
  <div id="hardLoginCard">
    <h2>Nevojitet hyrja</h2>
    <div style="opacity:.85">Vendos email-in e punës për t'u futur.</div>
    <div id="hardLoginRow">
      <input id="hardLoginEmail" type="email" placeholder="emri@aicorporation.al" />
      <button id="hardLoginBtn">Login</button>
    </div>
    <div id="hardLoginErr">Email i pavlefshëm.</div>
  </div>
</div>


<script>
(function(){
  const SESSION_KEY = "APP_SESSION";
  // Ensure we have appRoot
  const app = document.getElementById("appRoot");
  if(app){ app.style.display = "none"; }

  function getUsers(){
    try{
      if(window.UsersStore && typeof window.UsersStore.all === "function"){
        const ls = window.UsersStore.all();
        if(Array.isArray(ls) && ls.length) return ls;
      }
    }catch(e){}
    return Array.isArray(window.APP_USERS) ? window.APP_USERS : [];
  }

  function loadSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY)) || {}; }catch(e){ return {}; }
  }
  function saveSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s||{})); }

  function applyUI(){
    const s = loadSession();
    const overlay = document.getElementById("hardLoginOverlay");
    const who = document.getElementById("whoami");
    const bIn = document.getElementById("btnLogin");
    const bOut = document.getElementById("btnLogout");

    const logged = !!(s && s.email);
    if(app) app.style.display = logged ? "grid" : "none";
    if(overlay) overlay.style.display = logged ? "none" : "flex";
    if(who) who.textContent = logged ? `${s.name||s.email} (${s.role||'viewer'})` : "Pa hyrje (viewer)";
    if(bIn) bIn.style.display = logged ? "none":"inline-flex";
    if(bOut) bOut.style.display = logged ? "inline-flex":"none";

    // Disable/enable editing based on role
    const editor = (s.role || "").toLowerCase() === "editor";
    // Disable all inputs/selects/buttons inside tables if not editor
    try{
      const editableSelectors = ["input[type=text]","input[type=date]","input[type=checkbox]","select"];
      editableSelectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
          if(el.closest("table")){ el.disabled = !editor; }
        });
      });
      Array.from(document.querySelectorAll("button")).forEach(b=>{
        const txt = (b.textContent||"").toLowerCase();
        if(["ndrysho","fshi","shto","ruaj","save","edit","delete","add","kolonë","+ kolonë","add task","dërgo email","dergo email"].some(k=>txt.includes(k))){
          if(b.id !== "btnLogin" && b.id !== "btnLogout"){
            b.disabled = !editor;
          }
        }
      });
    }catch(e){}
  }

  function loginWith(email){
    email = (email||"").trim();
    if(!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
      const err = document.getElementById("hardLoginErr");
      if(err) err.style.display="block";
      return;
    }
    const list = getUsers();
    const match = (list||[]).find(u => (u.email||"").toLowerCase() === email.toLowerCase());
    let session;
    if(match){
      // use existing role
      session = { email: match.email, name: match.name, role: match.role };
      try{
        if(window.UsersStore && typeof UsersStore.remove==="function") UsersStore.remove(match.email);
        if(window.UsersStore && typeof UsersStore.add==="function") UsersStore.add(session);
      }catch(e){}
    }else{
      // default to viewer
      const namePart = email.split("@")[0] || "Viewer";
      session = { email, name: namePart, role: "viewer" };
      try{ if(window.UsersStore && typeof UsersStore.add==="function") UsersStore.add(session); }catch(e){}
    }
    saveSession(session);
    applyUI();
  }

  function logout(){
    saveSession({});
    applyUI();
  }

  // Wire overlay controls
  function wireLogin(){
    const btn = document.getElementById("hardLoginBtn");
    const inp = document.getElementById("hardLoginEmail");
    if(btn) btn.addEventListener("click", ()=> loginWith(inp.value));
    if(inp) inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loginWith(inp.value); });
    // Wire topbar buttons if exist
    document.getElementById("btnLogin")?.addEventListener("click", ()=>{
      document.getElementById("hardLoginOverlay").style.display="flex";
      setTimeout(()=> document.getElementById("hardLoginEmail")?.focus(), 50);
    });
    document.getElementById("btnLogout")?.addEventListener("click", logout);
  }

  // Ensure auth box exists (if the original script hasn't created it yet)
  function ensureAuthTopbar(){
    const topbar = document.querySelector(".topbar");
    if(!topbar) return;
    if(document.getElementById("authBox")) return;
    const wrap = document.createElement("div");
    wrap.id = "authBox";
    wrap.style.display = "flex";
    wrap.style.gap = "8px";
    wrap.style.alignItems = "center";
    wrap.style.marginLeft = "auto";
    wrap.innerHTML = `
      <span id="whoami" style="font-size:14px; color:#475569">Pa hyrje (viewer)</span>
      <button id="btnLogin" class="btn small">Login</button>
      <button id="btnLogout" class="btn small" style="display:none">Logout</button>
    `;
    topbar.appendChild(wrap);
  }

  function init(){
    ensureAuthTopbar();
    wireLogin();
    applyUI();
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }
})();
</script>


<script>
(function(){
  const SESSION_KEY = "APP_SESSION";

  // Fallback embedded users (editor/viewer)
  window.APP_USERS = Array.isArray(window.APP_USERS) ? window.APP_USERS : [
    { email: "view@aicorporation.al", name: "Viewer", role: "viewer" },
    { email: "edit@aicorporation.al", name: "Editor", role: "editor" }
  ];

  function getSession(){
    try { return JSON.parse(localStorage.getItem(SESSION_KEY)) || {}; } catch(e){ return {}; }
  }
  function setSession(s){
    localStorage.setItem(SESSION_KEY, JSON.stringify(s||{}));
  }

  function show(el, v){ if(el) el.style.display = v? "flex":"none"; }

  function applyUI(){
    const s = getSession();
    const logged = !!s.email;
    const app = document.getElementById("appRoot");
    const overlay = document.getElementById("hardLoginOverlay");
    if(app) app.style.display = logged ? "grid" : "none";
    if(overlay) show(overlay, !logged);

    // topbar labels/buttons if exist
    const who = document.getElementById("whoami");
    const bIn = document.getElementById("btnLogin");
    const bOut = document.getElementById("btnLogout");
    if(who) who.textContent = logged ? `${s.name||s.email} (${s.role||'viewer'})` : "Pa hyrje (viewer)";
    if(bIn) bIn.style.display = logged ? "none" : "inline-flex";
    if(bOut) bOut.style.display = logged ? "inline-flex" : "none";

    // enable/disable edit controls based on role
    const isEditor = (s.role||"").toLowerCase()==="editor";
    try{
      const editableSelectors = ["input[type=text]","input[type=date]","input[type=checkbox]","select"];
      editableSelectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
          if(el.closest("table")) el.disabled = !isEditor;
        });
      });
      document.querySelectorAll("button").forEach(b=>{
        const txt=(b.textContent||"").toLowerCase();
        if(["ndrysho","fshi","shto","ruaj","save","edit","delete","add","kolonë","+ kolonë","add task"].some(k=>txt.includes(k))){
          if(b.id!=="btnLogin" && b.id!=="btnLogout") b.disabled = !isEditor;
        }
      });
    }catch(e){}
  }

  function loginWithEmail(email){
    email = (email||"").trim();
    const err = document.getElementById("hardLoginErr");
    if(!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
      if(err) err.style.display="block";
      return;
    }
    const def = (window.APP_USERS||[]).find(u => (u.email||"").toLowerCase()===email.toLowerCase());
    const session = def ? { email:def.email, name:def.name, role:def.role }
                        : { email, name:(email.split("@")[0]||"User"), role:"viewer" };
    setSession(session);
    applyUI();
  location.reload();
}

  function logoutNow(){ setSession({}); applyUI(); location.reload(); }

  function wire(){
    // Guarantee auth box at topbar
    const topbar=document.querySelector(".topbar");
    if(topbar && !document.getElementById("authBox")){
      const wrap=document.createElement("div");
      wrap.id="authBox";
      wrap.style.display="flex";
      wrap.style.gap="8px";
      wrap.style.alignItems="center";
      wrap.style.marginLeft="auto";
      wrap.innerHTML = '<span id="whoami" style="font-size:14px; color:#475569">Pa hyrje (viewer)</span>\
                        <button id="btnLogin" class="btn small">Login</button>\
                        <button id="btnLogout" class="btn small" style="display:none">Logout</button>';
      topbar.appendChild(wrap);
    }
    // Wire overlay controls
    const btn = document.getElementById("hardLoginBtn");
    const inp = document.getElementById("hardLoginEmail");
    if(btn) btn.addEventListener("click", ()=> loginWithEmail(inp && inp.value));
    if(inp) inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loginWithEmail(inp.value); });

    document.getElementById("btnLogin")?.addEventListener("click", ()=>{
      const ov=document.getElementById("hardLoginOverlay"); if(ov) ov.style.display="flex";
      setTimeout(()=> document.getElementById("hardLoginEmail")?.focus(), 10);
    });
    document.getElementById("btnLogout")?.addEventListener("click", logoutNow);
  }

  function start(){
    // Show overlay if not logged
    const s=getSession();
    const overlay=document.getElementById("hardLoginOverlay");
    if(overlay) overlay.style.display = s && s.email ? "none":"flex";
    applyUI();
    wire();
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", start);
  }else{
    start();
  }
})();
</script>

</body>
</html>
