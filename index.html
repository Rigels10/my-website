<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AIC PROJECTS</title>
<style>
  :root{ --bg:#f7f8fb; --surface:#ffffff; --text:#0f172a; --muted:#cbd5e1; --line:#e5e7eb;
         --primary:#2563eb; --ok:#22c55e; --danger:#ef4444; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:var(--bg)}
  .app{display:grid; grid-template-columns: 270px 1fr; height:100vh}
  .sidebar{background:#0b1220; color:#e2e8f0; padding:12px 10px; overflow:auto}
  .content{display:flex; flex-direction:column; min-width:0}
  .topbar{height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 16px; background:var(--surface); border-bottom:1px solid var(--line)}
  .page{padding:16px; overflow:auto}
  .sb-h{font-size:12px; color:#94a3b8; letter-spacing:.08em; text-transform:uppercase; padding:10px 10px 6px}
  .fav{padding:6px 10px; display:flex; align-items:center; gap:8px; color:#e2e8f0}
  .fav:hover{background:#111827; border-radius:8px}
  .space-row{margin-bottom:2px}
  .space-item{padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px}
  .space-item:hover{background:#111827}
  .avatar{width:22px;height:22px;border-radius:6px;display:inline-grid;place-items:center;font-size:12px;font-weight:700;color:#0b1220}
  .name{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .icon-btn{width:22px;height:22px;border:1px dashed #334155; border-radius:6px; display:inline-grid; place-items:center; color:#94a3b8; cursor:pointer}
  .icon-btn:hover{background:#111827}
  .trash{border-color:#7f1d1d; color:#fca5a5}
  .children{margin:4px 0 8px 42px; display:none}
  .children.open{display:block}
  .child{padding:6px 8px; font-size:14px; color:#cbd5e1; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .child:hover{background:#0f172a}
  .child .x{margin-left:auto; opacity:.7; font-weight:700; padding:0 6px; border-radius:6px; cursor:pointer}
  .child .x:hover{background:#111827; color:#fecaca}
  .child.active{background:#1f2937; color:#fff}
  .new-space{padding:6px 10px; margin:6px 10px; color:#94a3b8; display:flex; align-items:center; gap:8px}
  .panel{background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:14px}
  .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:12px}
  .input{height:36px; border:1px solid var(--line); border-radius:10px; padding:0 10px; background:#fff}
  .tag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); background:#fff; border-radius:10px; font-size:13px}
  .status-dot{width:10px;height:10px;border-radius:999px;background:var(--ok);display:inline-block}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
  .btn.small{padding:6px 10px; font-size:13px}
  table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden}
  thead th{ text-align:left; font-size:13px; color:#475569; font-weight:600; padding:12px; background:#f8fafc; border-bottom:1px solid var(--line)}
  tbody td{ padding:12px; border-bottom:1px solid var(--line); background:#fff}
  tbody tr:last-child td{border-bottom:none}
  .pill{padding:6px 10px; border:1px solid var(--line); border-radius:10px; background:#f8fafc}
  .overlay{position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{width:740px; max-width:92vw; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden}
  .modal header{padding:16px 18px; font-weight:700; font-size:20px; border-bottom:1px solid var(--line)}
  .modal .body{padding:16px 18px}
  .modal .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .field{display:flex; flex-direction:column; gap:6px}
  .field label{font-size:14px; color:#334155}
  .field input[type="text"], .field input[type="email"], .field input[type="date"], .field select, .field textarea{
    height:40px; border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px; background:#fff;
  }
  .field textarea{height:120px; resize:vertical}
  .status-row{display:flex; gap:8px; align-items:center}
  .status-chip{border:1px solid var(--line); border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none}
  .status-chip.active{border-color:#93c5fd; background:#eff6ff; color:#1d4ed8}
  .modal footer{display:flex; justify-content:flex-end; gap:10px; padding:16px 18px; border-top:1px solid var(--line); background:#f8fafc}
  .upload{border:1px dashed #cbd5e1; border-radius:12px; padding:14px; background:#f9fafb}
  .drop{border:1px dashed #cbd5e1; border-radius:10px; padding:18px; text-align:center; font-size:14px; color:#475569; background:#fff}
  .filelist{margin-top:10px; display:flex; flex-direction:column; gap:6px; max-height:160px; overflow:auto}
  .fileitem{display:flex; justify-content:space-between; gap:10px; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff}
  .fileitem a{color:#2563eb; text-decoration:underline}
  .hint{font-size:12px; color:#64748b; margin-top:8px}

  /* === Status Colors === */
  .status-select{ border-radius: 999px; padding: 4px 10px; color:#fff; border:none; font-weight:600; }
  .status-open{ background:#22c55e; }      /* green */
  .status-close{ background:#ef4444; }     /* red */
  .status-done{ background:#10b981; }      /* emerald */
  .status-progress{ background:#3b82f6; }  /* blue */
  .status-onhold{ background:#f59e0b; }    /* amber */
  .status-blocked{ background:#6b7280; }   /* gray */
</style>
<style>
/* Templates UI */
#aicTplBtn{position:fixed;right:16px;bottom:16px;padding:12px 16px;border:1px solid #1d4ed8;border-radius:12px;background:#2563eb;color:#fff;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.25);cursor:pointer;z-index:2147483647}
#aicTplOverlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:2147483646}
#aicTplModal{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);min-width:720px;max-width:94vw;overflow:hidden}
#aicTplModal header{padding:12px 16px;border-bottom:1px solid #e5e7eb;font-weight:700}
#aicTplModal .body{padding:12px 16px}
#aicTplModal .list{width:100%;border-collapse:separate;border-spacing:0}
#aicTplModal th,#aicTplModal td{padding:8px 10px;border-bottom:1px solid #e5e7eb;text-align:left}
.aicTplSmall{padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#f9fafb;cursor:pointer}
.aicTplPrimary{background:#2563eb;color:#fff;border-color:#2563eb}
/* right‑click menu */
#aicTplCtx{position:fixed;z-index:2147483647;display:none;min-width:180px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.2);overflow:hidden}
#aicTplCtx button{display:block;width:100%;padding:8px 12px;border:0;background:#fff;text-align:left;cursor:pointer}
#aicTplCtx button:hover{background:#f3f4f6}
</style>

</head>
\1
<div id="auth-gate" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.85);z-index:9999;">
  <div style="background:#ffffff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:28px;max-width:420px;width:90%;text-align:center;">
    <h2 style="margin:0 0 8px 0;font-size:22px;line-height:1.2;color:#0f172a;">Hyni për të vazhduar</h2>
    <p style="margin:0 0 16px 0;color:#475569;">Ky aplikacion kërkon llogari Google për të lexuar/ruajtur në Firestore.</p>
    </div>
</div>
<div id="auth-controls" style="position:fixed;top:10px;right:10px;z-index:9998;display:none;">
  <button id="btn-logout" title="Dil" style="border:1px solid #e5e7eb;border-radius:9999px;padding:8px 12px;background:#ffffff;cursor:pointer;">Dil</button>
</div>

<!-- === Hard Login Overlay (added) === -->
<div id="hardLoginOverlay" style="position:fixed;inset:0;background:rgba(15,23,42,.92);display:flex;align-items:center;justify-content:center;z-index:99999">
  <div style="width:520px;max-width:92vw;background:#0b1220;color:#e2e8f0;border:1px solid #243045;border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.4)">
    <h2 style="margin:0 0 8px 0;font-size:22px">Hyni për të vazhduar</h2>
    <div style="opacity:.85">Vendos email-in e punës. Nëse nuk gjendet në listë, hyni si <b>viewer</b>.</div>
    <div style="display:flex;gap:8px;margin-top:14px">
      <input id="hardLoginEmail" type="email" placeholder="emri@aicorporation.al" style="flex:1;height:40px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;padding:0 12px" />
      <button id="hardLoginBtn" style="height:40px;border-radius:10px;border:1px solid #2563eb;background:#2563eb;color:#fff;padding:0 14px;cursor:pointer">Login</button>
    </div>
    <div id="hardLoginErr" style="display:none;color:#fca5a5;margin-top:10px;font-size:13px">Email i pavlefshëm.</div>
  </div>
</div>

<div class="app" id="appRoot">
  <aside class="sidebar">
    <div class="sb-h">Favorites</div>
    <div class="fav">⭐ All Tasks - Aicorporation</div>
    <div class="sb-h" style="display:flex; align-items:center; justify-content:space-between">
      <span>Spaces</span>
      <div id="btnAddSpace" class="icon-btn" title="Shto Hapësirë">+</div>
    </div>
    <div id="spacesWrap"></div>
    <div id="btnNewSpace" class="new-space">＋ New Space</div>
  </aside>

  <main class="content">
    <div class="topbar">
      <div style="font-weight:600">AIC Tasks</div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
        <span id="wsLabel" class="tag">Workspace: <b id="wsName" style="margin-left:6px"></b></span>
      </div>
    </div>

    <div class="page">
      <div id="taskPanel" class="panel" style="display:none">
        <h2 id="listTitle" style="margin:0 0 12px 0;border-bottom:3px solid #22c55e;padding-bottom:6px;font-size:18px;font-weight:700;color:#0f172a;display:none;"></h2>
        <div class="toolbar">
          <div style="flex:1"></div>
          <!-- KJO KUTI RUAJTET dhe PËRDORET për dërgim -->
          <input id="myEmail" class="input" style="width:260px" placeholder="Email-i im:" value="@aicorporation.al">
          <!-- Owner filter -->
          <select id="filterOwner" class="input">
            <option value="">Të gjitha</option>
            <option value="mine">Vetëm të mia</option>
          </select>
          <!-- Priority filter -->
          <select id="filterPriority" class="input">
            <option value="">Prioriteti</option>
            <option value="I Lartë">I Lartë</option>
            <option value="Mesëm">Mesëm</option>
            <option value="I Ulët">I Ulët</option>
          </select>
          <!-- Status filter -->
          <select id="filterStatus" class="input">
            <option value="">Statusi</option>
            <option value="OPEN">OPEN</option>
            <option value="IN PROGRESS">IN PROGRESS</option>
            <option value="DONE">DONE</option>
            <option value="CLOSED">CLOSED</option>
          </select>

          <button id="btnAddTask" class="btn primary">Add Task</button>
          <button id="btnAddColumn" class="btn">+ Kolonë</button>
          <button id="btnExportZip" class="btn">📦 Eksporto ZIP</button>
        </div>

        <div style="overflow:auto">
          <table class="tasks-table">
            <thead>
              <tr id="taskHeadRow">
                <th style="width:28%">Emri</th>
                <th style="width:12%">Assignee</th>
                <th style="width:10%">Afati</th>
                <th style="width:12%">Prioriteti</th>
                <th style="width:12%">Email assignee</th>
                <th style="width:10%">Status</th>
                <th style="width:16%">Veprime</th>
              </tr>
            </thead>
            <tbody id="taskBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- MODAL Add/Edit Task -->
<div id="overlay" class="overlay">
  <div class="modal">
    <header>Detyrë</header>
    <div class="body">
      <div class="grid">
        <div class="field"><label>Titulli</label><input id="f_title" type="text" placeholder="p.sh. Përgatit draft-kontratën"></div>
        <div class="field"><label>Assignee</label><input id="f_assignee" type="text" placeholder="Emri / inicialet"></div>
        <div class="field"><label>Email i assignee</label><input id="f_email" type="email" placeholder="emri@aicorporation.al"></div>
        <div class="field"><label>Afati</label><input id="f_due" type="date"></div>
        <div class="field"><label>Prioriteti</label>
          <select id="f_priority"><option>Mesëm</option><option>I Lartë</option><option>I Ulët</option></select>
        </div>
        <div class="field"><label>Statusi</label>
          <div id="f_status" class="status-row">
            <div data-v="OPEN" class="status-chip active">OPEN</div>
            <div data-v="CLOSED" class="status-chip">CLOSED</div>
          </div>
        </div>
        <div class="field" style="grid-column:1 / -1">
          <label>Përshkrimi</label><textarea id="f_desc" placeholder="Detaje të shkurtra..."></textarea>
        </div>
      </div>

      <div class="upload" id="uploadBox">
        <div class="field">
          <label>Dokumente (vetëm listim lokal për demonstrim)</label>
          <div id="drop" class="drop">
            Zvarrit dhe lësho dokumentat këtu, ose <u>zgjidh nga kompjuteri</u>.
            <input id="fileInput" type="file" multiple style="display:none">
          </div>
          <div class="hint" id="folderHint">Dosja: <b id="folderPath">/docs/—</b></div>
          <div id="fileList" class="filelist"></div>
        </div>
      </div>
    </div>
    <footer>
      <button id="btnCancel" class="btn">Anulo</button>
      <button id="btnSave" class="btn primary">Ruaj</button>
    </footer>
  </div>
</div>

<script src="./users.js"></script>
<script>
/* ------------------ Persistenca & konfigurimi ------------------ */
const KEY = "aicTasksV1";
const MYMAIL_KEY = "aicMyEmail";
window.data = [];
window._openSpaces = new Set(); // keeps which space indices are expanded
let current = { spaceIndex:null, listIndex:null };
let editingTaskIndex = null;

/* 🔎 Filtrat */
let priorityFilter = "";
let ownerFilter = "";   // "" | "mine"
let statusFilter = "";  // "" | "OPEN" | "IN PROGRESS" | "DONE" | "CLOSED"

function saveLocal(){
  const clean = JSON.parse(JSON.stringify(window.data));
  clean.forEach(sp=>sp.lists?.forEach(ls=>ls.tasks?.forEach(t=>{
    if(t.files){ t.files = t.files.map(({name,size,type})=>({name,size,type})); }
  })));
  localStorage.setItem(KEY, JSON.stringify(clean));
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(KEY);
    if(raw){
      window.data = JSON.parse(raw);
      window.data.forEach(sp=>sp.lists?.forEach(ls=>{ if(!ls.columns) ls.columns=[]; }));
      return;
    }
  }catch{}
  window.data = [];
window._openSpaces = new Set(); // keeps which space indices are expanded
saveLocal();
}

/* ------------------ Sidebar ------------------ */
const spacesWrap = document.getElementById("spacesWrap");
function renderSidebar(){
  spacesWrap.innerHTML = "";
  window.data.forEach((sp, sidx) => {
    const row = document.createElement("div"); row.className="space-row";
    const item = document.createElement("div"); item.className = "space-item";
    const avatar = document.createElement("div"); avatar.className = "avatar"; avatar.style.background = sp.color || "#f59e0b"; avatar.textContent = (sp.name?.trim()[0] || "S").toUpperCase();
    const name = document.createElement("div"); name.className = "name"; name.textContent = sp.name;
    name.ondblclick = (e)=>{ e.stopPropagation(); inlineRenameSpace(sidx, name); };
    const addListBtn = document.createElement("div"); addListBtn.className = "icon-btn"; addListBtn.title = "Shto Listë"; addListBtn.onclick = (e)=>{ e.stopPropagation(); addList(sidx); };
    const deleteSpaceBtn = document.createElement("div"); deleteSpaceBtn.className = "icon-btn trash"; deleteSpaceBtn.title="Fshi Hapësirën"; deleteSpaceBtn.textContent = "🗑"; deleteSpaceBtn.style.fontSize="12px"; deleteSpaceBtn.onclick = (e)=>{ e.stopPropagation(); deleteSpace(sidx); };
    item.append(avatar, name, addListBtn, deleteSpaceBtn);
    // Toggle with persistent state, and stop bubbling to avoid instant re-close
    item.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      const ch = row.querySelector('.children');
      const willOpen = !ch.classList.contains('open');
      ch.classList.toggle('open', willOpen);
      if(willOpen){ window._openSpaces.add(sidx); } else { window._openSpaces.delete(sidx); }
    });
    const children = document.createElement("div"); children.className="children";
    (sp.lists||[]).forEach((ls, lidx) => {
      const c = document.createElement("div"); c.className="child"; c.addEventListener('click', (e)=>{ e.stopPropagation(); });
      const txt = document.createElement("div"); txt.textContent = ls.name;
      txt.ondblclick = (e)=>{ e.stopPropagation(); inlineRenameList(sidx, lidx, txt); };
      const x = document.createElement("div"); x.className="x"; x.title="Fshi Listën"; x.textContent="×"; x.onclick = (e)=>{ e.stopPropagation(); deleteList(sidx, lidx); };
      c.onclick = (e)=>{ e.stopPropagation(); openList(sidx, lidx); };
      c.append(txt, x); children.append(c);
    });
    if(window._openSpaces.has(sidx)) children.classList.add('open');
    row.append(item, children); spacesWrap.append(row);
  });
}
function addSpace(){
  const name = prompt("Emri i Hapësirës:", "Hapësirë e re"); if(!name) return;
  const color = "#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0");
  window.data.push({name, color, lists:[]}); saveData(); renderSidebar();
}
function deleteSpace(sidx){
  if(!confirm(`Ta fshij “${window.data[sidx].name}” dhe të gjitha Listat/Detyrat e saj?`)) return;
  window.data.splice(sidx,1);
  if(current.spaceIndex===sidx){ document.getElementById("taskPanel").style.display="none"; current={spaceIndex:null,listIndex:null}; }
  saveData(); renderSidebar();
}
function addList(sidx){
  const name = prompt("Emri i Listës:", "Listë e re"); if(!name) return;
  window.data[sidx].lists = window.data[sidx].lists || [];
  window.data[sidx].lists.push({name, tasks:[], columns:[]}); saveData(); renderSidebar();
  const block = spacesWrap.children[sidx]; if(block){ block.querySelector(".children").classList.add("open"); }
}
function deleteList(sidx, lidx){
  if(!confirm(`Ta fshij Listën “${window.data[sidx].lists[lidx].name}”?`)) return;
  window.data[sidx].lists.splice(lidx,1);
  if(current.spaceIndex===sidx && current.listIndex===lidx){ document.getElementById("taskPanel").style.display="none"; current={spaceIndex:null,listIndex:null}; }
  saveData(); renderSidebar();
}
document.getElementById("btnAddSpace").onclick = addSpace;
document.getElementById("btnNewSpace").onclick = addSpace;

/* ------------------ Dynamic Columns (per List) ------------------ */
function ensureListSchema(ls){
  if(!ls.columns) ls.columns = [];               // [{id,name,type}]
  if(!ls.tasks)   ls.tasks   = [];
  ls.tasks.forEach(t=>{ if(!t.extras) t.extras = {}; });
}
function genId(){ return "c" + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function addColumnPrompt(){
  const name = prompt("Titulli i kolonës:", "Kolonë e re"); if(!name) return;
  let type = prompt("Tipi i kolonës (text | checkbox | date):", "text");
  type = (type||"text").trim().toLowerCase();
  if(!['text','checkbox','date'].includes(type)) type = 'text';
  const ls = window.data[current.spaceIndex].lists[current.listIndex];
  ensureListSchema(ls);
  const col = {id: genId(), name, type};
  ls.columns.push(col);
  ls.tasks.forEach(t=>{ if(!t.extras) t.extras={}; t.extras[col.id] = (type==='checkbox'? false : ''); });
  saveData();
  rebuildTaskHeader(); renderTasks();
}
function renameColumn(ls, cidx, thEl){
  if(typeof makeInlineRename === 'function'){
    makeInlineRename(thEl, ls.columns[cidx].name, (v)=>{ ls.columns[cidx].name=v; saveData(); rebuildTaskHeader(); });
  }else{
    const v = prompt('Emri i ri i kolonës:', ls.columns[cidx].name);
    if(v){ ls.columns[cidx].name=v; saveData(); rebuildTaskHeader(); }
  }
}
function rebuildTaskHeader(){
  const headRow = document.getElementById('taskHeadRow');
  if(!headRow) return;
  headRow.innerHTML = '';
  const base = [
    ['Emri','28%'],
    ['Assignee','12%'],
    ['Afati','10%'],
    ['Prioriteti','12%'],
    ['Email assignee','12%']
  ];
  base.forEach(([label,w])=>{
    const th=document.createElement('th'); if(w) th.style.width=w; th.textContent=label; headRow.append(th);
  });
  const ls = window.data?.[current.spaceIndex]?.lists?.[current.listIndex];
  if(ls){
    ensureListSchema(ls);
    ls.columns.forEach((col, cidx)=>{
      const th=document.createElement('th'); th.textContent=col.name; th.className='col-dynamic';
      th.title='Double-click për të riemërtuar';
      th.ondblclick = ()=>renameColumn(ls, cidx, th);
      headRow.append(th);
    });
  }
  const thStatus=document.createElement('th'); thStatus.style.width='10%'; thStatus.textContent='Status'; headRow.append(thStatus);
  const thAct=document.createElement('th'); thAct.style.width='16%'; thAct.textContent='Veprime'; headRow.append(thAct);
}
setTimeout(()=>{ const btn=document.getElementById('btnAddColumn'); if(btn) btn.onclick=addColumnPrompt; },0);

/* ------------------ Status helpers ------------------ */
function statusClassFor(val){
  if(!val) return 'status-progress';
  const v = (''+val).toLowerCase().replace(/\s+/g,'');
  if(v==='open') return 'status-open';
  if(v==='close' || v==='closed') return 'status-close';
  if(v==='done' || v==='completed') return 'status-done';
  if(v==='inprogress' || v==='progress') return 'status-progress';
  if(v==='onhold' || v==='hold') return 'status-onhold';
  if(v==='blocked') return 'status-blocked';
  return 'status-progress';
}
function applyStatusClass(el, val){ el.className = 'status-select ' + statusClassFor(val); }
function refreshAllStatusColors(){
  document.querySelectorAll('select').forEach(s=>{
    if(s && s.options && s.className && s.className.indexOf('status-select')>-1){
      applyStatusClass(s, s.value);
    }
  });
}

/* ------------------ Task table ------------------ */
const taskPanel = document.getElementById("taskPanel");
const taskBody  = document.getElementById("taskBody");
function openList(sidx, lidx){
  current = {spaceIndex:sidx, listIndex:lidx};
  [...document.querySelectorAll(".child")].forEach(el=>el.classList.remove("active"));
  const block = spacesWrap.children[sidx];
  const child = block.querySelectorAll(".child")[lidx];
  if(child) child.classList.add("active");
  taskPanel.style.display = "block";

  // Vendos titullin e panelit (vija jeshile)
  const titleEl = document.getElementById("listTitle");
  if (titleEl) {
    const spaceName = window.data?.[sidx]?.name || "";
    const listName  = window.data?.[sidx]?.lists?.[lidx]?.name || "";
    titleEl.textContent = `${spaceName} — ${listName}`.trim();
    titleEl.style.display = "block";
  }

  renderTasks();
}
function mkButton(txt, disabled=false, onclick=null){
  const b=document.createElement("button"); b.className="pill"; b.textContent=txt; b.disabled=disabled; if(onclick) b.onclick=onclick; return b;
}

function renderTasks(){
  taskBody.innerHTML = "";
  const list = window.data[current.spaceIndex]?.lists?.[current.listIndex];
  if(!list){ return; }
  ensureListSchema(list);
  rebuildTaskHeader();

  // 🧩 Mblidh dhe aplikoni filtrat
  const myEmail = (document.getElementById("myEmail")?.value || "").trim().toLowerCase();
  let tasks = [...(list.tasks || [])];

  // Filtri i pronarit
  if (ownerFilter === "mine" && myEmail) {
    tasks = tasks.filter(t => (t.email || "").trim().toLowerCase() === myEmail);
  }

  // Filtri i prioritetit
  if (priorityFilter) {
    const pf = priorityFilter.toLowerCase();
    tasks = tasks.filter(t => (t.priority || "").toLowerCase() === pf);
  }

  // Filtri i statusit
  if (statusFilter) {
    tasks = tasks.filter(t => (t.status || "OPEN") === statusFilter);
  }

  // Shfaqja e rreshtave
  tasks.forEach((t, idx) => {
    const tr = document.createElement("tr");
    const td = (html)=>{ const e=document.createElement("td"); e.innerHTML = html; return e; };
    const attach = t.files?.length ? ` &nbsp;📎 (${t.files.length})` : "";
    tr.append(td((t.name||"") + attach));
    tr.append(td(t.assignee||"—"));
    tr.append(td(t.due? new Date(t.due).toLocaleDateString() : "—"));
    tr.append(td(t.priority||"—"));
    tr.append(td(t.email||"—"));

    // Dynamic columns
    list.columns.forEach(col=>{
      const cell = document.createElement("td");
      if(!t.extras) t.extras = {};
      if(!(col.id in t.extras)) t.extras[col.id] = (col.type==="checkbox"? false : "");
      if(col.type === "text"){
        const inp = document.createElement("input"); inp.type="text"; inp.className="input";
        inp.value = t.extras[col.id] || "";
        inp.onchange = ()=>{ t.extras[col.id] = inp.value; saveData(); };
        cell.appendChild(inp);
      }else if(col.type === "date"){
        const inp = document.createElement("input"); inp.type="date"; inp.className="input";
        if(t.extras[col.id]) inp.value = t.extras[col.id];
        inp.onchange = ()=>{ t.extras[col.id] = inp.value; saveData(); };
        cell.appendChild(inp);
      }else{ // checkbox
        const inp = document.createElement("input"); inp.type="checkbox";
        inp.checked = !!t.extras[col.id];
        inp.onchange = ()=>{ t.extras[col.id] = inp.checked; saveData(); };
        cell.appendChild(inp);
      }
      tr.append(cell);
    });

    const statusTd = document.createElement("td");
    const sel = document.createElement("select"); applyStatusClass(sel, t.status); sel.className="input";
    ["OPEN","IN PROGRESS","DONE","CLOSED"].forEach(st=>{
      const o=document.createElement("option"); o.value=st; o.textContent=st; if((t.status||"OPEN")===st) o.selected=true; sel.append(o);
    });
    sel.onchange = () => { applyStatusClass(sel, sel.value); t.status = sel.value; saveData(); };
    applyStatusClass(sel, sel.value || t.status);
    statusTd.append(sel); tr.append(statusTd);

    const actions = document.createElement("td");
    const wrap = document.createElement("div"); wrap.style.display="flex"; wrap.style.gap="8px";
    const bEmail = mkButton("Dërgo Email", false, ()=>sendEmail(t));
    const bEdit  = mkButton("Ndrysho", false, ()=>openModal(idx));
    const bDel   = mkButton("Fshi", false, ()=>deleteTask(idx));
    const bDocs  = mkButton("Dokumente", false, ()=>showFiles(idx));
    wrap.append(bEmail,bEdit,bDel,bDocs); actions.append(wrap); tr.append(actions);

    taskBody.append(tr);
  });
}
function deleteTask(i){
  if(!confirm("Ta fshij detyrën?")) return;
  const list = window.data[current.spaceIndex].lists[current.listIndex];
  list.tasks.splice(i,1); saveData(); renderTasks();
}
document.getElementById("btnAddTask").onclick = ()=>openModal(null);

/* ------------------ Dërgo Email (mailto) ------------------ */
function sendEmail(task){
  try{
    const s = JSON.parse(localStorage.getItem("APP_SESSION")||"{}");
    const isEditor = (s.role||"").toLowerCase()==="editor";
    if(!isEditor){ alert("Veprimi lejohet vetëm për rolin 'editor'."); return; }
  }catch(e){}
  const myEmailEl = document.getElementById("myEmail");
  const senderRemember = (myEmailEl?.value||"").trim();
  if(senderRemember) localStorage.setItem(MYMAIL_KEY, senderRemember);

  const to = encodeURIComponent((task.email||"").trim());
  const subject = encodeURIComponent("Detyrë: " + (task.name||""));
  const docs = (task.files||[]).map(f => `- ${f.name||""}`).join("\n");
  const body = encodeURIComponent(
`Përshëndetje,

Detyrë: ${task.name||"—"}
Afati: ${task.due||"—"}
Prioriteti: ${task.priority||"—"}
Statusi: ${task.status||"OPEN"}

Përshkrimi:
${task.desc||"—"}

Lidhjet:
${docs||"—"}

Dërguar nga: ${senderRemember||"-"}
`);
  window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
}

/* ------------------ Modal & Upload (lokal) ------------------ */
const overlay = document.getElementById("overlay");
const f_title  = document.getElementById("f_title");
const f_assignee = document.getElementById("f_assignee");
const f_email  = document.getElementById("f_email");
const f_due    = document.getElementById("f_due");
const f_priority = document.getElementById("f_priority");
const f_desc   = document.getElementById("f_desc");
const f_status = document.getElementById("f_status");
const folderPath = document.getElementById("folderPath");
const fileInput  = document.getElementById("fileInput");
const drop       = document.getElementById("drop");
const fileList   = document.getElementById("fileList");
let tempFiles = []; // [{name,size,type}]

function setStatus(v){
  f_status.querySelectorAll(".status-chip").forEach(ch=>ch.classList.remove("active"));
  const el=[...f_status.children].find(x=>x.dataset.v===v); if(el) el.classList.add("active");
}
function getStatus(){
  const el=[...f_status.children].find(x=>x.classList.contains("active"));
  return el?el.dataset.v:"OPEN";
}
f_status.querySelectorAll(".status-chip").forEach(ch=>ch.onclick = ()=> setStatus(ch.dataset.v));

function openModal(taskIndex){
  if(current.spaceIndex===null) return alert("Zgjidh një Listë nga majtas.");
  editingTaskIndex = taskIndex;
  const sp = window.data[current.spaceIndex]; const ls = sp.lists[current.listIndex];
  folderPath.textContent = `/docs/${slug(sp.name)}/${slug(ls.name)}/`;
  tempFiles = [];

  if(taskIndex===null){
    f_title.value=""; f_assignee.value=""; f_email.value=""; f_due.value=""; f_priority.value="Mesëm"; f_desc.value="";
    setStatus("OPEN"); renderTempFiles();
  } else {
    const t = ls.tasks[taskIndex];
    f_title.value=t.name||""; f_assignee.value=t.assignee||""; f_email.value=t.email||"";
    f_due.value=t.due? t.due.substring(0,10):""; f_priority.value=t.priority||"Mesëm"; f_desc.value=t.desc||"";
    setStatus(t.status||"OPEN");
    tempFiles = (t.files||[]).slice(); renderTempFiles();
  }
  overlay.style.display="flex";
}
function closeModal(){ overlay.style.display="none"; }
document.getElementById("btnCancel").onclick = closeModal;

document.getElementById("btnSave").onclick = ()=>{
  const list = window.data[current.spaceIndex].lists[current.listIndex];
  const obj = {
    name: f_title.value || "Untitled",
    assignee: f_assignee.value || "—",
    email: f_email.value || "—",
    due: f_due.value || "",
    priority: f_priority.value,
    desc: f_desc.value || "",
    status: getStatus(),
    files: tempFiles
  };
  if(!list.tasks) list.tasks = [];
  if(editingTaskIndex===null) list.tasks.push(obj); else list.tasks[editingTaskIndex]=obj;
  saveData(); renderTasks(); closeModal();
};

// Upload lokal (vetëm listim; pa server)
drop.onclick = ()=>fileInput.click();
drop.ondragover = (e)=>{ e.preventDefault(); drop.style.background="#f1f5f9"; };
drop.ondragleave = ()=>{ drop.style.background="#fff"; };
drop.ondrop = (e)=>{ e.preventDefault(); drop.style.background="#fff"; handleUpload(e.dataTransfer.files); };
fileInput.onchange = ()=>handleUpload(fileInput.files);
function handleUpload(files){
  [...files].forEach(f=> tempFiles.append({name:f.name, size:f.size, type:f.type}));
  renderTempFiles();
}
function renderTempFiles(){
  fileList.innerHTML="";
  tempFiles.forEach((f,i)=>{
    const row = document.createElement("div"); row.className="fileitem";
    const left = document.createElement("div"); left.textContent = `${f.name} (${Math.round((f.size||0)/1024)} KB)`;
    const right = document.createElement("div");
    const rm = document.createElement("button"); rm.className="btn small"; rm.textContent="Hiq";
    rm.onclick=()=>{ tempFiles.splice(i,1); renderTempFiles(); };
    right.append(rm);
    row.append(left,right); fileList.append(row);
  });
}
function showFiles(i){ openModal(i); }

/* ===== Inline Rename Helpers ===== */
function makeInlineRename(el, initialValue, onSave){
  if(el.dataset.editing === "1") return;
  el.dataset.editing = "1";
  const oldText = initialValue ?? el.textContent.trim();
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldText;
  input.className = "input";
  input.style.height = "28px";
  input.style.padding = "0 8px";
  input.style.borderRadius = "8px";
  input.style.width = Math.max(120, el.clientWidth + 20) + "px";
  el.replaceWith(input);
  input.focus(); input.select();

  let cancelled = false;
  function commit(){
    if(cancelled){ input.replaceWith(el); el.dataset.editing=""; return; }
    const v = input.value.trim() || oldText;
    onSave(v);
    el.textContent = v;
    input.replaceWith(el);
    el.dataset.editing = "";
  }
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); commit(); }
    if(e.key === "Escape"){ cancelled = true; commit(); }
  });
  input.addEventListener("blur", commit);
}
function inlineRenameSpace(sidx, el){
  makeInlineRename(el, null, (v)=>{
    window.data[sidx].name = v;
    saveData();
    renderSidebar();
  });
}
function inlineRenameList(sidx, lidx, el){
  makeInlineRename(el, null, (v)=>{
    window.data[sidx].lists[lidx].name = v;
    saveData();
    renderSidebar();
    if(current.spaceIndex===sidx && current.listIndex===lidx){
      renderTasks && renderTasks();
    }
  });
}
/* ------------------ Helpers & Init ------------------ */
function slug(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); }
loadLocal(); renderSidebar();
const myEmailEl = document.getElementById("myEmail");
myEmailEl.value = localStorage.getItem(MYMAIL_KEY) || myEmailEl.value || "";
myEmailEl.addEventListener("input", ()=>localStorage.setItem(MYMAIL_KEY, myEmailEl.value.trim()));

/* 🔗 Lidh eventet e filtrave */
const filterPriorityEl = document.getElementById("filterPriority");
const filterOwnerEl = document.getElementById("filterOwner");
const filterStatusEl = document.getElementById("filterStatus");

function triggerRefresh(){ renderTasks(); }

filterPriorityEl?.addEventListener("change", () => { priorityFilter = filterPriorityEl.value || ""; triggerRefresh(); });
filterOwnerEl?.addEventListener("change",   () => { ownerFilter = filterOwnerEl.value || "";   triggerRefresh(); });
filterStatusEl?.addEventListener("change",  () => { statusFilter = filterStatusEl.value || ""; triggerRefresh(); });

document.addEventListener('DOMContentLoaded', ()=>{ try{ refreshAllStatusColors(); }catch(e){} });

// Provide a simple global render used by cloud loader
window.render = function(){ renderSidebar(); if(current.spaceIndex!=null && current.listIndex!=null){ renderTasks(); } };
</script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ===== Firebase Config (shared + realtime) ===== */
// Workspace nga URL (?space=...)
const urlParams = new URLSearchParams(location.search);
const WORKSPACE_ID = (urlParams.get('space') || 'aic').trim().toLowerCase();
document.getElementById('wsName').textContent = WORKSPACE_ID;

// Path i përbashkët (shared) për këtë variant UI
const sharedDocRef = db.collection('spaces').doc(WORKSPACE_ID).collection('app').doc('v2');

// Debounce helper
let saveTimer = 0;
function debounce(fn, ms){
  return function(){ clearTimeout(saveTimer); const args=arguments; saveTimer=setTimeout(()=>fn.apply(null,args), ms); };
}

// ⬆️ Ruajtje: lokale + cloud (shared)
async function saveData(){
  try{
    // 1) lokale
    saveLocal();
    // 2) cloud
    const payload = { data: window.data, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
    await sharedDocRef.set(payload);
  }catch(e){ console.error(e); }
}
const saveDataDebounced = debounce(saveData, 400);

// 🔄 Real-time subscribe nga cloud (shared)
let initialPulled = false;
sharedDocRef.onSnapshot(snap => {
  if(snap.exists){
    const cloud = snap.data()?.data || [];
    // shmang riloop-in: mos e mbishkruaj nëse është identike me lokale
    const local = localStorage.getItem(KEY);
    const was = local ? JSON.parse(local) : null;
    const same = JSON.stringify(was) === JSON.stringify(cloud);
    window.data = cloud;
    if(!same){ saveLocal(); }
    window.render();
    initialPulled = true;
  } else {
    // nëse s'ka doc në cloud, shty lokale si default shared
    if(!initialPulled){
      sharedDocRef.set({ data: window.data, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).catch(console.error);
      initialPulled = true;
    }
  }
});

// Patch operacionet që modifikojnë të dhënat të përdorin ruajtje të debounced
(function(){
  const _push = Array.prototype.push;
  // Nuk po monkey-patch gjithë JS-in; mjafton të thërrasim saveDataDebounced kudo ku kemi saveData
  const origSave = window.saveData;
  window.saveData = function(){
    try{ if(typeof origSave === 'function') origSave(); }catch(e){}
    saveDataDebounced();
  };
})();
</script>

<!-- === Role-based login & guards (added) === -->
<script>
(function(){
  const SESSION_KEY = "APP_SESSION";

  function getSession(){ try{ return JSON.parse(localStorage.getItem(SESSION_KEY))||{}; }catch(e){ return {}; } }
  function setSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s||{})); }
  function isEditor(){ const s=getSession(); return (s.role||"").toLowerCase()==="editor"; }

  // Resolve role from APP_USERS if provided by users.js
  function resolveRole(email){
    try{
      const list = Array.isArray(window.APP_USERS) ? window.APP_USERS : [];
      const hit = list.find(u => (u.email||'').toLowerCase() === email.toLowerCase());
      if (hit) return {name: hit.name||email.split('@')[0], role: (hit.role||'viewer').toLowerCase()};
      if (/@aicorporation\.al$/i.test(email)) return {name: email.split('@')[0], role:'editor'};
      return {name: email.split('@')[0], role:'viewer'};
    }catch(e){
      return {name: email.split('@')[0], role:'viewer'};
    }
  }

  function applyRoleUI(){
    const s = getSession();
    const logged = !!s.email;
    const overlay = document.getElementById('hardLoginOverlay');
    if(overlay) overlay.style.display = logged ? 'none' : 'flex';

    // Disable header buttons safely (if they exist)
    const ids = ['btnAddTask','btnAddColumn','btnAddSpace','btnNewSpace'];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.disabled = !isEditor(); }});

    // Also (soft) disable table controls for viewers: we'll enforce via event guard below too
    try {
      document.querySelectorAll(".tasks-table input, .tasks-table select, .tasks-table .pill").forEach(el=>{
        if(el.tagName === 'BUTTON') el.disabled = !isEditor();
        else el.disabled = !isEditor();
      });
    }catch(e){}
  }

  // Wire login
  function mountLogin(){
    const btn = document.getElementById('hardLoginBtn');
    const inp = document.getElementById('hardLoginEmail');
    const err = document.getElementById('hardLoginErr');
    function doLogin(){
      const email = (inp && inp.value || '').trim();
      const ok = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
      if(!ok){ if(err) err.style.display='block'; return; }
      const roleInfo = resolveRole(email);
      setSession({ email, name: roleInfo.name, role: roleInfo.role });
      applyRoleUI();
    }
    if(btn) btn.addEventListener('click', doLogin);
    if(inp) inp.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
  }

  // Monkey-patch mutating functions to require editor
  function guardMutations(){
    const wrap = (name)=>{
      const orig = window[name];
      if(typeof orig!=='function') return;
      window[name] = function(){
        if(!isEditor()){ alert("Veprimi lejohet vetëm për rolin 'editor'."); return; }
        return orig.apply(this, arguments);
      };
    };
    ['addSpace','deleteSpace','addList','deleteList','addColumnPrompt','renameColumn','openModal','deleteTask'].forEach(wrap);
  }

  // Global event guard to prevent inline edits by viewers in table cells
  function mountEventGuards(){
    document.addEventListener('change', function(e){
      if(isEditor()) return;
      const t = e.target;
      if(!t) return;
      if(t.closest('.tasks-table')){
        // revert the change
        if(t.type==='checkbox'){ t.checked = !t.checked; }
        else { e.preventDefault(); if('value' in t) t.value = t.getAttribute('value') || t.value; }
        alert("Vetëm 'editor' mund të bëjë ndryshime.");
      }
    }, true);

    document.addEventListener('click', function(e){
      if(isEditor()) return;
      const btn = e.target.closest('.pill,.btn');
      if(btn && (btn.textContent||'').match(/Ndrysho|Fshi|Add Task|Kolon|Dokumente/i)){
        e.preventDefault(); e.stopPropagation();
        alert("Veprimi lejohet vetëm për rolin 'editor'.");
      }
    }, true);
  }

  // Run after page scripts loaded
  function init(){
    mountLogin();
    guardMutations();
    mountEventGuards();
    applyRoleUI();
  }

  // Delay init until DOMContentLoaded so that original functions are defined
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();
</script>

<!-- Space Templates UI -->
<button id="aicTplBtn">Template-t</button>
<div id="aicTplOverlay">
  <div id="aicTplModal">
    <header style="display:flex;align-items:center;justify-content:space-between">
      <span>Space Templates</span>
      <button id="aicTplClose" class="aicTplSmall">Mbyll</button>
    </header>
    <div class="body">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <input id="aicTplName" class="input" style="flex:1" placeholder="Emri i template-it">
        <button id="aicTplSave" class="aicTplSmall aicTplPrimary">Ruaj si template</button>
      </div>
      <div style="font-size:12px;color:#64748b;margin-bottom:10px">Ky template ruan vetëm *strukturën*: Emrin e Space dhe emrat e Listave (jo detyrat/kolonat).</div>
      <table class="list">
        <thead><tr><th>Emri</th><th>Space + Listat</th><th>Veprime</th></tr></thead>
        <tbody id="aicTplBody"></tbody>
      </table>
    </div>
  </div>
</div>
<div id="aicTplCtx"><button id="aicTplCtxSave">Ruaj si template</button></div>

<script>
(function(){
  const KEY='AIC_SPACE_TEMPLATES_V1';
  let templates=[];
  let ctxSidx=null; // space index captured from right-click
  let pendingTpl=null; // last captured structure

  function load(){ try{ templates=JSON.parse(localStorage.getItem(KEY))||[]; }catch(e){ templates=[]; } }
  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(templates)); }catch(e){} }

  // Helpers to render list
  function renderList(){
    const body=document.getElementById('aicTplBody'); body.innerHTML='';
    if(!templates.length){
      const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=3; td.style.padding='10px'; td.textContent='Asnjë template ende.'; tr.appendChild(td); body.appendChild(tr);
      return;
    }
    templates.forEach(t=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); td1.textContent=t.name;
      const td2=document.createElement('td'); td2.textContent='Space: '+t.space+' | Lista: '+(t.lists||[]).join(', ');
      const td3=document.createElement('td');
      const use=document.createElement('button'); use.className='aicTplSmall'; use.textContent='Përdor'; use.onclick=()=>applyTemplate(t);
      const del=document.createElement('button'); del.className='aicTplSmall'; del.style.marginLeft='8px'; del.textContent='Fshi'; del.onclick=()=>{ if(confirm('Ta fshij?')){ templates=templates.filter(x=>x.id!==t.id); save(); renderList(); }};
      td3.appendChild(use); td3.appendChild(del);
      tr.append(td1,td2,td3); body.appendChild(tr);
    });
  }

  // Modal open/close
  const overlay=document.getElementById('aicTplOverlay');
  const btn=document.getElementById('aicTplBtn');
  const close=document.getElementById('aicTplClose');
  function openModal(prefill){
    load(); if(prefill){ pendingTpl=prefill; document.getElementById('aicTplName').value=prefill.name||prefill.space||''; } else { pendingTpl=null; document.getElementById('aicTplName').value=''; }
    renderList(); overlay.style.display='flex';
  }
  function closeModal(){ overlay.style.display='none'; }
  btn.addEventListener('click', ()=>openModal());
  close.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });

  // Save template (from modal header button) — uses pendingTpl captured from right-click
  document.getElementById('aicTplSave').addEventListener('click', ()=>{
    if(!pendingTpl){ alert('Kliko me të djathtën te një Space dhe zgjidh “Ruaj si template”.'); return; }
    const name=(document.getElementById('aicTplName').value||'').trim() || pendingTpl.space;
    const tpl={ id:'sp_'+Date.now().toString(36), name, space: pendingTpl.space, lists: (pendingTpl.lists||[]).slice() };
    templates.push(tpl); save(); renderList(); alert('U ruajt.');
  });

  // Right-click menu in sidebar
  const ctx=document.getElementById('aicTplCtx');
  document.addEventListener('click', ()=>ctx.style.display='none');
  document.addEventListener('scroll', ()=>ctx.style.display='none', true);
  const spacesWrap=document.getElementById('spacesWrap');
  spacesWrap.addEventListener('contextmenu', function(e){
    const item=e.target.closest('.space-item');
    if(!item) return;
    e.preventDefault();
    // find space index by row order
    const row=item.parentElement;
    const rows=[...spacesWrap.querySelectorAll('.space-row')];
    ctxSidx=rows.indexOf(row);
    ctx.style.left=e.clientX+'px'; ctx.style.top=e.clientY+'px'; ctx.style.display='block';
  });

  document.getElementById('aicTplCtxSave').addEventListener('click', function(){
    ctx.style.display='none';
    if(ctxSidx==null){ alert('S’gjeta Space.'); return; }
    const sp=(window.data||[])[ctxSidx]; if(!sp){ alert('S’gjeta Space.'); return; }
    const lists=(sp.lists||[]).map(l=>l.name||'Listë');
    pendingTpl={space:sp.name||'Space', lists:lists, name: sp.name||'Space'};
    openModal(pendingTpl); // hap modalin të shohësh/ruash
  });

  // Apply template: shton një Space në sidebar + listat (direkt në modelin e të dhënave)
  function applyTemplate(t){
    try{
      const color = "#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0");
      const spaceObj = { name: t.space, color, lists: (t.lists||[]).map(n=>({name:n, tasks:[], columns:[]})) };
      window.data = Array.isArray(window.data) ? window.data : [];
      window.data.push(spaceObj);
      // ruaj & rifresko
      if(typeof saveData==='function') saveData();
      if(typeof renderSidebar==='function') renderSidebar();
      alert('U shtua Space “'+t.space+'” me listat.');
    }catch(e){
      console.error(e); alert('S’ia dola të shtoj template-in.');
    }
  }

  // Shkurtore: Ctrl+Alt+T
  document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.altKey && (e.key==='t'||e.key==='T')) openModal(); });
})();
</script>

<!-- LIGHT NO-ROLES PATCH (keeps handlers intact) -->
<script>
(function(){
  try {
    localStorage.setItem("APP_SESSION", JSON.stringify({
      email: "info@aicorporation.al",
      name: "AIC",
      role: "editor"
    }));
  } catch(e) {}
  try { window.isEditor = function(){ return true; }; } catch(e){}
  // Hide login overlays if present, but do not touch app handlers
  const hide = sel => document.querySelectorAll(sel).forEach(n=>{ try{ n.remove(); }catch(e){} try{ n.style.display='none'; }catch(e){} });
  const run = ()=>{
    hide("#loginOverlay"); hide(".login-overlay"); hide("#authOverlay"); hide(".auth-overlay");
    document.querySelectorAll("div,section,article,main").forEach(el=>{
      const t=(el.textContent||"").toLowerCase();
      const st=getComputedStyle(el);
      if((st.position==='fixed'||st.position==='absolute') && (t.includes('hyni për të vazhduar')||/\blogin\b/.test(t))) {
        try{el.remove();}catch(e){} try{el.style.display='none';}catch(e){}
      }
    });
  };
  run(); setTimeout(run,200); setTimeout(run,800);
})();
</script>

<!-- ===== Export XLSX per Space -> ZIP (workspace-named) ===== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
(function(){
  function fmtDate(d){
    if(!d) return "";
    var dt = (typeof d==="number" || /^\d+$/.test(String(d))) ? new Date(Number(d)) : new Date(d);
    return isNaN(dt.getTime()) ? "" : dt.toLocaleString();
  }
  function fmtUser(u){
    if(!u) return "";
    if(typeof u==="string") return u;
    if(typeof u==="object"){
      var name = u.name || u.fullName || u.displayName || u.username;
      var email = u.email || u.mail || (u.user && u.user.email);
      var id = u.id || u._id || u.userId;
      return name || email || id || "";
    }
    return "";
  }
  function safeFileName(s){
    return (s||"Projekt").replace(/[<>:"/\\|?*\x00-\x1F]/g,"-").replace(/\s+/g," ").trim();
  }
  function safeSheetName(s){
    s = (s||"").replace(/[:\\/?*\[\]]/g,"-").slice(0,31);
    return s || "Sheet";
  }

  async function exportSpacesAsZip(){
    try{
      var spaces = Array.isArray(window.data) ? window.data : [];
      if(!spaces.length){ alert("S'ka të dhëna për eksport."); return; }

      var zip = new JSZip();
      var stamp = new Date().toISOString().slice(0,10);
      var ws = (typeof WORKSPACE_ID!=="undefined" && WORKSPACE_ID) ? WORKSPACE_ID : (document.getElementById("wsName")?.textContent || "aic");
      ws = safeFileName(ws.toLowerCase());
      spaces.forEach(function(space){
        var wb = XLSX.utils.book_new();
        (space.lists||[]).forEach(function(list){
          var cols = (list.columns||[]).map(function(c){ return { id:c.id, name:c.name, type:c.type||"text" }; });

          var baseHeaders   = ["Emri","ID e detyrës","Assignee","Afati","Prioriteti","Email assignee"];
          var dynamicHeader = cols.map(function(c){ return c.name; });
          var tailHeaders   = ["Status","Përshkrimi","Dokumente (#)","Krijuar më","Përditësuar më","Krijuar nga","Përditësuar nga"];
          var headers = baseHeaders.concat(dynamicHeader).concat(tailHeaders);

          var rows = (list.tasks||[]).map(function(t){
            var taskId    = t?.id ?? t?._id ?? t?.key ?? "";
            var created   = t?.createdAt ?? t?.created_at ?? t?.created ?? "";
            var updated   = t?.updatedAt ?? t?.updated_at ?? t?.updated ?? "";
            var createdBy = t?.createdBy ?? t?.created_by ?? t?.author;
            var updatedBy = t?.updatedBy ?? t?.updated_by ?? t?.lastEditor;

            var base = [
              t?.name || "",
              taskId,
              t?.assignee || "",
              t?.due ? fmtDate(t.due) : "",
              t?.priority || "",
              t?.email || ""
            ];
            var dyn = cols.map(function(c){
              var v = (t?.extras && (c.id in t.extras)) ? t.extras[c.id] : "";
              if(c.type==="checkbox") return v ? "Po" : "Jo";
              return (v==null?"":v);
            });
            var tail = [
              t?.status || "OPEN",
              t?.desc || "",
              Array.isArray(t?.files) ? t.files.length : 0,
              fmtDate(created),
              fmtDate(updated),
              fmtUser(createdBy),
              fmtUser(updatedBy)
            ];
            return base.concat(dyn).concat(tail);
          });

          var wsData = [headers].concat(rows);
          var sheet = XLSX.utils.aoa_to_sheet(wsData);
          var sname = safeSheetName(list?.name || "Listë");
          var uniq = sname, i=2;
          while(wb.SheetNames.indexOf(uniq)>-1){ uniq = safeSheetName(sname + " ("+ (i++) +")"); }
          XLSX.utils.book_append_sheet(wb, sheet, uniq);
        });

        var fname = safeFileName((space?.name||"Space")) + "-" + new Date().toISOString().slice(0,10) + ".xlsx";
        var wbOut = XLSX.write(wb, { bookType:"xlsx", type:"array" });
        zip.file(fname, wbOut);
      });

      var blob = await zip.generateAsync({ type:"blob" });
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = ws + "-" + stamp + ".zip"; // EmriWorkspace-YYYY-MM-DD.zip
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(function(){ URL.revokeObjectURL(a.href); }, 2000);
    }catch(e){
      console.error(e);
      alert("Ndodhi një gabim gjatë eksportit.");
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    var btn = document.getElementById("btnExportZip");
    if(btn){ btn.addEventListener("click", exportSpacesAsZip); }
  });
})();
</script>

  <!-- Firebase SDK (compat) -->

  <script>
    // Firebase config provided by the user
    const firebaseConfig = {
      apiKey: "AIzaSyB9gJOvrRatlOpw7IXNmwnnNQYv9ivFYmU",
      authDomain: "aic-m-4460f.firebaseapp.com",
      projectId: "aic-m-4460f",
      storageBucket: "aic-m-4460f.firebasestorage.app",
      messagingSenderId: "884813548315",
      appId: "1:884813548315:web:0723e1899e0acc6fc2e1be",
      measurementId: "G-NQN1J1SHJF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadSpacesFromFirestore() {
      try {
        const snapshot = await db.collection('spaces').get();
        const spaces = [];
        snapshot.forEach(doc => spaces.push(doc.data()));
        window.data = spaces;
        console.log("✅ Firestore u lidh, spaces:", spaces);
      } catch (e) {
        console.error("❌ Firestore error:", e);
      }
    }
    // Ngarko të dhënat; eksporti ZIP përdor window.data
    </script>
<script>
  auth.onAuthStateChanged((user) => {
    if (user) {
      console.log("✅ Logged in:", user.email);
      showGate(false);
      // Load Firestore data after login
      if (typeof loadSpacesFromFirestore === 'function') {
        loadSpacesFromFirestore();
      }
    } else {
      console.log("ℹ️ Not logged in");
      showGate(true);
    }
  });
</script>

<script>
  // --- Auth wiring (requires firebase-auth-compat) ---
  const auth = firebase.auth();
  provider.setCustomParameters({ prompt: 'select_account' });

  catch (e) {
      console.error("Sign-in error:", e);
      alert("S’u krye hyrja: " + (e?.message || e));
    }
  }
  async function signOut() {
    try {
      await auth.signOut();
    } catch (e) {
      console.error("Sign-out error:", e);
    }
  }

  document.addEventListener('click', (ev) => {
    if (ev.target && ev.target.id === 'btn-logout') signOut();
  });

  function showGate(show) {
    const gate = document.getElementById('auth-gate');
    const ctrl = document.getElementById('auth-controls');
    if (!gate || !ctrl) return;
    gate.style.display = show ? 'flex' : 'none';
    ctrl.style.display = show ? 'none' : 'block';
  }
</script>

<script>
  function setAuthMsg(type, text) {
    const err = document.getElementById('auth-error');
    const info = document.getElementById('auth-info');
    if (!err || !info) return;
    err.style.display = 'none';
    info.style.display = 'none';
    if (type === 'error') { err.textContent = text; err.style.display = 'block'; }
    if (type === 'info')  { info.textContent = text; info.style.display = 'block'; }
  }

  async function emailLogin(email, password) {
    try {
      await auth.signInWithEmailAndPassword(email, password);
      setAuthMsg('info', 'U futët me sukses.');
    } catch (e) {
      console.error(e);
      setAuthMsg('error', e && e.message ? e.message : 'Nuk u krye hyrja.');
    }
  }

  async function emailRegister(email, password) {
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      try { await cred.user.sendEmailVerification(); } catch {}
      setAuthMsg('info', 'Llogaria u krijua. Kontrollo email-in për verifikim.');
    } catch (e) {
      console.error(e);
      setAuthMsg('error', e && e.message ? e.message : 'Nuk u krijua llogaria.');
    }
  }

  async function emailReset(email) {
    try {
      await auth.sendPasswordResetEmail(email);
      setAuthMsg('info', 'U dërgua email për rivendosjen e fjalëkalimit.');
    } catch (e) {
      console.error(e);
      setAuthMsg('error', e && e.message ? e.message : 'Nuk u dërgua email-i i rivendosjes.');
    }
  }

  // Wire events
  document.addEventListener('submit', (ev) => {
    if (ev.target && ev.target.id === 'email-signin-form') {
      ev.preventDefault();
      const email = document.getElementById('email-input')?.value?.trim();
      const pass = document.getElementById('password-input')?.value;
      if (email && pass) emailLogin(email, pass);
    }
  });
  document.addEventListener('click', (ev) => {
    const email = document.getElementById('email-input')?.value?.trim();
    const pass = document.getElementById('password-input')?.value;
    if (ev.target && ev.target.id === 'btn-email-register') {
      ev.preventDefault();
      if (email && pass) emailRegister(email, pass);
    }
    if (ev.target && ev.target.id === 'btn-email-reset') {
      ev.preventDefault();
      if (email) emailReset(email);
      else setAuthMsg('error', 'Shkruaj email-in përpara.');
    }
  });
</script>
</body>
</html>
